<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ & ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à) + ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</title>
    
    <!-- ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ‡πÇ‡∏´‡∏•‡∏î Google Font Sarabun TH -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <!-- ‡πÇ‡∏´‡∏•‡∏î Library ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PDF/Capture -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        
        /* Style ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ A4 */
        #quotation-output, #receipt-output {
            background-color: white;
            padding: 2.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            min-height: 1123px; width: 794px; margin: auto;
        }
        
        @media print {
            .modal-hidden-on-print, .no-print { display: none !important; }
            .page-container { box-shadow: none !important; margin: 0 !important; }
        }

        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .active-tab { background-color: #4f46e5; color: white; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .inactive-tab { background-color: #eef2ff; color: #4f46e5; border: 1px solid #c7d2fe; }
        .inactive-tab:hover { background-color: #e0e7ff; }

        #loadingOverlay {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="p-4 md:p-8 relative">

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 z-[100] bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full opacity-0 flex items-center">
        <span id="toastMessage">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 z-[90] hidden items-center justify-center">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10 text-indigo-600 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-indigo-800 font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</span>
        </div>
    </div>

    <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h1>
        <p class="text-center text-gray-500 mb-6 text-sm">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</p>
        
        <!-- Main Navigation -->
        <div class="no-print flex flex-wrap justify-center gap-3 mb-8 border-b-2 pb-4">
            <button onclick="switchView('quotation')" id="btnQuotation" class="px-6 py-2 rounded-lg font-bold transition duration-150 active-tab">
                üìù ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
            </button>
            <button onclick="switchView('receipt')" id="btnReceipt" class="px-6 py-2 rounded-lg font-bold transition duration-150 inactive-tab">
                üßæ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
            </button>
            
            <!-- Cloud Actions -->
            <div class="flex gap-2 ml-0 md:ml-4 border-l-2 pl-4 border-gray-200">
                <button onclick="saveQuotationToCloud()" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-bold shadow-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
                <button onclick="openSavedListModal()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-bold shadow-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                </button>
            </div>
        </div>

        <!-- 0. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ -->
        <section class="mb-6 p-4 border border-blue-200 rounded-lg bg-blue-50 no-print">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold text-blue-700">0. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)</h2>
                <button onclick="toggleSection('sellerSection')" class="text-blue-500 text-sm hover:underline">‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á</button>
            </div>
            <div id="sellerSection">
                <input id="sellerName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢)" value="‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏à‡∏≥‡∏Å‡∏±‡∏î" class="w-full p-3 mb-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150">
                <textarea id="sellerInfo" rows="2" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà, ‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ, ‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå ‡∏Ø‡∏•‡∏Ø" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150">99/9 ‡∏´‡∏°‡∏π‡πà 9 ‡∏ñ‡∏ô‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏ï‡∏≥‡∏ö‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 10000</textarea>
                <input type="text" id="sellerTaxId" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ (‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à)" value="1234567890123" class="w-full mt-2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150">
            </div>
        </section>

        <!-- QUOTATION VIEW -->
        <div id="quotationView" class="view-content">
            <section class="mb-8 p-4 border border-indigo-200 rounded-lg bg-indigo-50">
                <h2 class="text-xl font-semibold text-indigo-700 mb-4">1. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
                <div class="space-y-4">
                    <input id="customerName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó" class="w-full p-3 border border-gray-300 rounded-lg">
                    <textarea id="customerAddress" rows="3" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà" class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                    <input id="quotationDate" type="date" class="w-full p-3 border border-gray-300 rounded-lg" required>
                </div>
            </section>

            <section class="mb-8 p-4 border border-green-200 rounded-lg bg-green-50">
                <h2 class="text-xl font-semibold text-green-700 mb-4">2. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤</h2>
                <div id="productContainer" class="space-y-8">
                    <!-- ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ 1 -->
                    <div id="product-1" class="p-4 border border-green-300 rounded-lg bg-white shadow-md">
                        <h3 class="font-bold text-xl text-green-600 mb-1 flex items-center flex-wrap gap-2">
                            ‡∏â‡∏≤‡∏Å‡∏Å‡∏±‡πâ‡∏ô PVC <span class="text-gray-500 text-lg font-normal flex items-center">(‡∏£‡∏´‡∏±‡∏™ <input type="text" id="product-code-1" value="SN390-10" class="mx-1 p-1 border border-green-300 rounded text-sm w-28 text-green-700 bg-green-50">)</span>
                        </h3>
                        <p class="text-sm text-gray-500 mb-3">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ‡∏Ç‡∏ô‡∏≤‡∏î ‡∏Å‡∏ß‡πâ‡∏≤‡∏á x ‡∏™‡∏π‡∏á, ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á/‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡∏≤‡∏á</p>
                        <div id="product-items-1" class="space-y-4 mb-4"></div>
                        <button type="button" onclick="addItemRow(1)" class="w-full py-2 bg-green-100 text-green-700 font-semibold rounded-lg hover:bg-green-200 border-dashed border-2 border-green-300">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏â‡∏≤‡∏Å‡∏Å‡∏±‡πâ‡∏ô PVC</button>
                    </div>

                    <!-- ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ 2 -->
                    <div id="product-2" class="p-4 border border-green-300 rounded-lg bg-white shadow-md">
                        <h3 class="font-bold text-xl text-green-600 mb-1 flex items-center flex-wrap gap-2">
                            ‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô Blackout <span class="text-gray-500 text-lg font-normal flex items-center">(‡∏£‡∏´‡∏±‡∏™ <input type="text" id="product-code-2" value="RBP-3901" class="mx-1 p-1 border border-green-300 rounded text-sm w-28 text-green-700 bg-green-50">)</span>
                        </h3>
                        <p class="text-sm text-gray-500 mb-3">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ‡∏Ç‡∏ô‡∏≤‡∏î ‡∏Å‡∏ß‡πâ‡∏≤‡∏á x ‡∏™‡∏π‡∏á, ‡∏õ‡∏£‡∏±‡∏ö‡∏ã‡πâ‡∏≤‡∏¢/‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ß‡∏≤</p>
                        <div id="product-items-2" class="space-y-4 mb-4"></div>
                        <button type="button" onclick="addItemRow(2)" class="w-full py-2 bg-green-100 text-green-700 font-semibold rounded-lg hover:bg-green-200 border-dashed border-2 border-green-300">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô Blackout</button>
                    </div>
                </div>
                
                <div class="mt-6 p-4 rounded-lg bg-green-100">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                        <div class="bg-white p-3 rounded-lg border border-green-300 shadow-sm">
                            <span class="font-bold text-gray-700 block mb-2">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏©‡∏µ (VAT 7%):</span>
                            <div class="flex space-x-4">
                                <label class="inline-flex items-center cursor-pointer"><input type="radio" name="quotationVatOption" value="include" class="form-radio text-green-600 w-5 h-5" checked><span class="ml-2">‡∏Ñ‡∏¥‡∏î VAT (+7%)</span></label>
                                <label class="inline-flex items-center cursor-pointer"><input type="radio" name="quotationVatOption" value="none" class="form-radio text-green-600 w-5 h-5"><span class="ml-2">‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î VAT</span></label>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-gray-800">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: <span id="quotationSubtotalDisplay" class="text-red-600">0.00</span> ‡∏ö‡∏≤‡∏ó</p>
                            <small class="text-gray-600">* ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ (Subtotal)</small>
                        </div>
                    </div>
                </div>
            </section>

            <section class="mb-8 p-4 border border-yellow-200 rounded-lg bg-yellow-50">
                <h2 class="text-xl font-semibold text-yellow-700 mb-4">3. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>
                <div class="flex justify-end mb-3">
                    <button id="generatePaymentBtn" onclick="generatePaymentDetails()" class="flex items-center space-x-2 bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded-lg shadow-md">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zM8.32 14.28a1 1 0 01-1.41 1.41A6 6 0 1113 7.64a1 1 0 011.85-.75l.17.42A8 8 0 1010 18a8 8 0 000-16zm.18-1.42a1 1 0 00-.81.25l-.23.23a1 1 0 00.7.35l.11-.01.1-.03a1 1 0 00.7-.35zM9 10a1 1 0 100-2 1 1 0 000 2z"/></svg>
                        <span>‚ú® ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (AI)</span>
                    </button>
                </div>
                <div class="space-y-3">
                    <textarea id="paymentDetail" rows="2" placeholder="‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (‡πÄ‡∏ä‡πà‡∏ô: ‡∏°‡∏±‡∏î‡∏à‡∏≥ 50%)" class="w-full p-3 border border-gray-300 rounded-lg"></textarea>
                    <input id="bankName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£" class="w-full p-3 border border-gray-300 rounded-lg">
                    <input id="accountNumber" type="text" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" class="w-full p-3 border border-gray-300 rounded-lg">
                    <input id="accountName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" class="w-full p-3 border border-gray-300 rounded-lg">
                </div>
            </section>

            <div class="flex justify-center">
                <button onclick="generateQuotation()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 active:scale-100">
                    ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (Preview)
                </button>
            </div>
        </div>

        <!-- RECEIPT VIEW -->
        <div id="receiptView" class="view-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <h3 class="font-semibold mb-2 text-blue-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                    <input type="text" id="rCustomerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" class="w-full mb-2 p-2 border rounded-lg">
                    <textarea id="rCustomerAddress" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" class="w-full p-2 border rounded-lg resize-none h-12"></textarea>
                    <input type="text" id="rCustomerTaxId" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ" class="w-full mt-2 p-2 border rounded-lg">
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border flex flex-col justify-between">
                    <div>
                        <h3 class="font-semibold mb-2 text-blue-600">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</h3>
                        <div class="flex justify-between mb-2">
                            <label class="font-medium text-gray-700 w-1/3">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</label>
                            <input type="text" id="receiptNo" value="REC-202410-001" class="w-2/3 p-2 border rounded-lg text-right">
                        </div>
                        <div class="flex justify-between mb-2">
                            <label class="font-medium text-gray-700 w-1/3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                            <input type="date" id="receiptDate" class="w-2/3 p-2 border rounded-lg text-right">
                        </div>
                        <div class="flex justify-between">
                            <label class="font-medium text-gray-700 w-1/3">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞:</label>
                            <select id="paymentMethod" class="w-2/3 p-2 border rounded-lg bg-white text-right">
                                <option value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                                <option value="‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</option>
                                <option value="‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="no-print flex justify-end mb-4">
                <button onclick="populateReceiptFromQuotation()" class="flex items-center space-x-2 bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg shadow-md">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M15.312 11.424a1.05 1.05 0 01-.06 1.06l-1.636 1.73a.87.87 0 00-.21 1.077c.433.864.137 2.01-.727 2.443L9.61 18.995c-1.488.744-3.328-.31-3.665-1.928l-.055-.251c-.125-.63.26-1.25.89-1.375l2.497-.499a.87.87 0 00.707-.29l1.96-2.185a1.5 1.5 0 000-2.072l-1.96-2.185a.87.87 0 00-.707-.29l-2.497-.499c-.63-.125-1.015-.745-.89-1.375l.056-.251c.337-1.618 2.177-2.672 3.665-1.928l4.08 2.04c.864.433 1.16 1.579.727 2.443a.87.87 0 00-.21 1.077l1.636 1.73a1.05 1.05 0 01-.06 1.06z" clip-rule="evenodd" /></svg>
                    <span>‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</span>
                </button>
            </div>
            
            <div class="overflow-x-auto mb-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-50">
                        <tr>
                            <th class="px-3 py-3 text-left w-1/12">#</th>
                            <th class="px-6 py-3 text-left w-5/12">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th class="px-6 py-3 text-right w-2/12">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th class="px-6 py-3 text-right w-2/12">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th class="px-6 py-3 text-right w-2/12">‡∏£‡∏ß‡∏°</th>
                            <th class="px-1 py-3 w-1/12 no-print"></th>
                        </tr>
                    </thead>
                    <tbody id="receiptItemTableBody" class="bg-white divide-y divide-gray-100 text-sm"></tbody>
                </table>
            </div>
            
            <div class="flex justify-end mb-4 no-print">
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 shadow-sm">
                    <span class="font-bold text-gray-700 block mb-2 text-sm">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏©‡∏µ (VAT 7%):</span>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center cursor-pointer"><input type="radio" name="receiptVatOption" value="include" class="form-radio text-blue-600 w-4 h-4" checked onchange="calculateReceiptTotals()"><span class="ml-2 text-sm">‡∏Ñ‡∏¥‡∏î VAT (+7%)</span></label>
                        <label class="inline-flex items-center cursor-pointer"><input type="radio" name="receiptVatOption" value="none" class="form-radio text-blue-600 w-4 h-4" onchange="calculateReceiptTotals()"><span class="ml-2 text-sm">‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î VAT</span></label>
                    </div>
                </div>
            </div>

            <div class="no-print mt-6 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button onclick="addItemRowReceipt('', 1, 0)" class="px-6 py-3 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Manual)</button>
                <button onclick="generateReceipt()" class="px-8 py-3 bg-blue-600 text-white text-lg font-bold rounded-lg shadow-xl hover:bg-blue-700">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</button>
            </div>
        </div>
    </div>

    <!-- Modals (Quotation, Receipt, SavedList) -->
    <div id="savedListModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center"><h3 class="text-2xl font-bold">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h3><button onclick="closeModal(null, 'savedList')" class="text-gray-500 text-2xl">&times;</button></div>
            <div id="savedListContainer" class="p-6 overflow-y-auto flex-1 space-y-2 bg-gray-50"><p class="text-center text-gray-500 mt-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p></div>
        </div>
    </div>
    
    <div id="quotationModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50 overflow-y-auto" onclick="closeModal(event, 'quotation')">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl my-8">
            <div class="flex justify-between items-center p-4 bg-indigo-50 border-b"><h3 class="text-2xl font-bold">‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h3><button onclick="closeModal(null, 'quotation')" class="text-gray-600 text-3xl">&times;</button></div>
            <div id="quotationPreview" class="p-2 overflow-y-auto max-h-[85vh]"><div id="quotation-output"></div></div>
            <div class="p-4 border-t flex justify-center gap-4"><button onclick="downloadPDF('quotation')" class="bg-red-600 text-white px-6 py-2 rounded-lg">‚¨áÔ∏è PDF</button><button onclick="captureScreen('quotation')" class="bg-green-600 text-white px-6 py-2 rounded-lg">üì∑ Copy Image</button><div id="quotationCopyMessage" class="hidden text-green-700 self-center">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!</div></div>
        </div>
    </div>

    <div id="receiptModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50 overflow-y-auto" onclick="closeModal(event, 'receipt')">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl my-8">
            <div class="flex justify-between items-center p-4 bg-blue-50 border-b"><h3 class="text-2xl font-bold">‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3><button onclick="closeModal(null, 'receipt')" class="text-gray-600 text-3xl">&times;</button></div>
            <div id="receiptPreview" class="p-2 overflow-y-auto max-h-[85vh]"><div id="receipt-output"></div></div>
            <div class="p-4 border-t flex justify-center gap-4"><button onclick="downloadPDF('receipt')" class="bg-red-600 text-white px-6 py-2 rounded-lg">‚¨áÔ∏è PDF</button><button onclick="captureScreen('receipt')" class="bg-green-600 text-white px-6 py-2 rounded-lg">üì∑ Copy Image</button><div id="receiptCopyMessage" class="hidden text-green-700 self-center">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!</div></div>
        </div>
    </div>

    <script type="module">
        // --- 1. FIREBASE MODULAR IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, deleteDoc, getDocs, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 2. CONFIGURATION & GLOBAL STATE ---
        const apiKey = ""; // API Key for Gemini
        const firebaseConfig = {}; // Placeholder for manual config
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-shop-app';
        
        let auth, db, currentUser;
        let isFirebaseReady = false; // Flag for authentication readiness

        const products = {
            1: { id: 1, name: '‡∏â‡∏≤‡∏Å‡∏Å‡∏±‡πâ‡∏ô PVC', option1: '‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á', option2: '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡∏≤‡∏á' },
            2: { id: 2, name: '‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô Blackout', option1: '‡∏õ‡∏£‡∏±‡∏ö‡∏ã‡πâ‡∏≤‡∏¢', option2: '‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ß‡∏≤' }
        };
        let nextRowId = 1;
        let receiptItemCounter = 0;


        // --- 3. FIREBASE INITIALIZATION (‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠) ---
        async function initFirebase() {
            let configToUse = firebaseConfig;
            try {
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    configToUse = JSON.parse(__firebase_config);
                }

                if (!configToUse || !configToUse.apiKey) {
                    console.warn("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà Firebase Config (‡πÇ‡∏´‡∏°‡∏î Offline)");
                    return;
                }

                const app = initializeApp(configToUse);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        isFirebaseReady = true;
                        console.log("Firebase Ready. User:", user.uid);
                    } else {
                        try {
                            // Sign in using custom token from Canvas or anonymously
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                            currentUser = auth.currentUser;
                            isFirebaseReady = true;
                            console.log("Firebase Ready after sign-in. User:", currentUser.uid);
                        } catch (e) {
                            console.error("Auth Fail:", e);
                            isFirebaseReady = true; // Still mark ready to prevent continuous attempts
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase Init Error:", error);
            }
        }
        initFirebase();


        // --- 4. UTILITY FUNCTIONS ---
        function switchView(viewName) {
            document.getElementById('quotationView').classList.toggle('hidden', viewName !== 'quotation');
            document.getElementById('receiptView').classList.toggle('hidden', viewName !== 'receipt');
            document.getElementById('btnQuotation').className = viewName === 'quotation' ? 'px-6 py-2 rounded-lg font-bold transition duration-150 active-tab' : 'px-6 py-2 rounded-lg font-bold transition duration-150 inactive-tab';
            document.getElementById('btnReceipt').className = viewName === 'receipt' ? 'px-6 py-2 rounded-lg font-bold transition duration-150 active-tab' : 'px-6 py-2 rounded-lg font-bold transition duration-150 inactive-tab';
            if (viewName === 'receipt') syncCustomerInfoToReceipt();
        }

        function toggleSection(id) { document.getElementById(id).classList.toggle('hidden'); }
        function showLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }
        function closeModal(e, type) { 
            const id = type === 'quotation' ? 'quotationModal' : (type === 'receipt' ? 'receiptModal' : 'savedListModal');
            if (!e || e.target.id === id) document.getElementById(id).style.display = 'none';
        }
        function syncCustomerInfoToReceipt() {
            document.getElementById('rCustomerName').value = document.getElementById('customerName').value;
            document.getElementById('rCustomerAddress').value = document.getElementById('customerAddress').value;
        }

        function showToast(msg, err=false) {
            const t = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = msg;
            t.classList.remove('translate-x-full', 'opacity-0', 'bg-gray-800', 'bg-red-600');
            t.classList.add('translate-x-0', 'opacity-100', err ? 'bg-red-600' : 'bg-gray-800');
            setTimeout(() => t.classList.add('translate-x-full', 'opacity-0'), 3000);
        }

        function fetchWithExponentialBackoff(url, options) {
            const maxRetries = 5;
            let delay = 1000;

            async function attempt(retryCount) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (retryCount < maxRetries) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                        return attempt(retryCount + 1);
                    }
                    throw error;
                }
            }
            return attempt(0);
        }

        // --- Row Management ---
        function createProductRowHtml(productId, rowId, initialValues = {}) {
            const p = products[productId];
            const isInitial = document.getElementById(`product-items-${productId}`).childElementCount === 0 && !initialValues.force;
            const { width='', height='', qty=1, price='', option=p.option1 } = initialValues;

            return `
                <div id="item-row-${rowId}" data-product-id="${productId}" class="grid grid-cols-6 gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200 items-center mb-2">
                    <input type="number" data-field="width" placeholder="‡∏Å‡∏ß‡πâ‡∏≤‡∏á (‡∏ã‡∏°.)" value="${width}" class="col-span-2 md:col-span-1 p-2 border rounded-lg" onchange="calculateQuotationTotal()">
                    <input type="number" data-field="height" placeholder="‡∏™‡∏π‡∏á (‡∏ã‡∏°.)" value="${height}" class="col-span-2 md:col-span-1 p-2 border rounded-lg" onchange="calculateQuotationTotal()">
                    <select data-field="option" class="col-span-2 md:col-span-1 p-2 border rounded-lg" onchange="calculateQuotationTotal()">
                        <option value="${p.option1}" ${option === p.option1 ? 'selected' : ''}>${p.option1}</option>
                        <option value="${p.option2}" ${option === p.option2 ? 'selected' : ''}>${p.option2}</option>
                    </select>
                    <input type="number" data-field="qty" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" class="col-span-3 md:col-span-1 p-2 border rounded-lg" min="1" value="${qty}" onchange="calculateQuotationTotal()">
                    <input type="number" data-field="price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ä‡∏∏‡∏î" class="col-span-3 md:col-span-1 p-2 border rounded-lg" value="${price}" onchange="calculateQuotationTotal()">
                    <div class="col-span-6 md:col-span-1 flex justify-end">
                        <button type="button" onclick="removeRow(${rowId})" class="w-full md:w-auto p-2 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150 ${isInitial ? 'opacity-0 pointer-events-none' : ''}">‡∏•‡∏ö</button>
                    </div>
                </div>
            `;
        }

        function addItemRow(productId, isInitialLoad = false, initialValues = {}) {
            const container = document.getElementById(`product-items-${productId}`);
            const newRowId = nextRowId++;
            container.insertAdjacentHTML('beforeend', createProductRowHtml(productId, newRowId, initialValues));
            if (!isInitialLoad) {
                calculateQuotationTotal();
                const btn = document.querySelector(`#item-row-${newRowId} button`);
                if(btn) btn.classList.remove('opacity-0', 'pointer-events-none');
            }
        }

        function removeRow(rowId) {
            const row = document.getElementById(`item-row-${rowId}`);
            if (row) {
                const pid = row.getAttribute('data-product-id');
                row.remove();
                // Ensure at least one blank row remains if possible
                if (document.getElementById(`product-items-${pid}`).childElementCount === 0) addItemRow(parseInt(pid), true);
                calculateQuotationTotal();
            }
        }

        function calculateQuotationTotal() {
            let subtotal = 0;
            document.querySelectorAll('#productContainer [data-product-id]').forEach(row => {
                const q = parseFloat(row.querySelector('[data-field="qty"]').value) || 0;
                const p = parseFloat(row.querySelector('[data-field="price"]').value) || 0;
                subtotal += q * p;
            });
            document.getElementById('quotationSubtotalDisplay').textContent = subtotal.toLocaleString('th-TH', {minimumFractionDigits: 2});
        }
        
        function calculateReceiptTotals() {
            let subtotal = 0;
            document.querySelectorAll('#receiptItemTableBody tr').forEach(row => {
                const q = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const p = parseFloat(row.querySelector('.item-price').value) || 0;
                const total = q * p;
                row.querySelector('.item-total').textContent = total.toLocaleString('th-TH', {minimumFractionDigits: 2});
                subtotal += total;
            });
            // This app doesn't have a dedicated receipt total display outside the modal, so we just calculate.
            // The total logic is in createReceiptHtml, but we need to ensure the calculation runs.
            return subtotal;
        }

        // --- 5. DATA HANDLING ---
        function getQuotationFormData() {
            const vatOption = document.querySelector('input[name="quotationVatOption"]:checked').value;
            const code1 = document.getElementById('product-code-1').value;
            const code2 = document.getElementById('product-code-2').value;
            
            const data = {
                sellerName: document.getElementById('sellerName').value,
                sellerInfo: document.getElementById('sellerInfo').value,
                sellerTaxId: document.getElementById('sellerTaxId').value,
                customerName: document.getElementById('customerName').value,
                customerAddress: document.getElementById('customerAddress').value,
                quotationDate: document.getElementById('quotationDate').value,
                paymentDetail: document.getElementById('paymentDetail').value,
                bankName: document.getElementById('bankName').value,
                accountNumber: document.getElementById('accountNumber').value,
                accountName: document.getElementById('accountName').value,
                vatOption, 
                customCodes: { 1: code1, 2: code2 },
                items: []
            };

            document.querySelectorAll('#productContainer [data-product-id]').forEach(row => {
                const pid = parseInt(row.getAttribute('data-product-id'));
                const p = products[pid];
                const w = parseFloat(row.querySelector('[data-field="width"]').value) || 0;
                const h = parseFloat(row.querySelector('[data-field="height"]').value) || 0;
                const q = parseFloat(row.querySelector('[data-field="qty"]').value) || 0;
                const pr = parseFloat(row.querySelector('[data-field="price"]').value) || 0;
                const opt = row.querySelector('[data-field="option"]').value;
                const code = pid === 1 ? code1 : code2;

                if (q > 0 || pr > 0) { // Only save meaningful rows
                    data.items.push({
                        productId: pid,
                        name: p.name,
                        code: code,
                        description: `${p.name} ${w>0&&h>0 ? `‡∏Ç‡∏ô‡∏≤‡∏î: ${w}x${h} ‡∏ã‡∏°.` : ''} (${opt})`,
                        qty: q,
                        unitPrice: pr,
                        total: q * pr,
                        raw: { width: row.querySelector('[data-field="width"]').value, height: row.querySelector('[data-field="height"]').value, option: opt, qty: q, price: pr }
                    });
                }
            });
            
            data.subtotal = data.items.reduce((s, i) => s + i.total, 0);
            return data;
        }

        // --- 6. CLOUD FUNCTIONS (Modular Syntax) ---
        async function saveQuotationToCloud() {
            if (!db) { showToast("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase (Offline Mode)", true); return; }
            if (!isFirebaseReady || !currentUser) { 
                showToast("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà", true); 
                return; 
            }
            
            const name = prompt("‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:", document.getElementById('customerName').value);
            if (!name) return;

            showLoading(true);
            try {
                const data = { 
                    ...getQuotationFormData(), 
                    title: name, 
                    createdAt: serverTimestamp(),
                    userId: currentUser.uid 
                };
                
                // Use modular addDoc and collection
                const userQuotesCollection = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'quotations');
                await addDoc(userQuotesCollection, data);
                
                showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            } catch (e) { 
                console.error("Save Error:", e); 
                showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${e.message}`, true); 
            }
            finally { showLoading(false); }
        }

        async function fetchSavedQuotations() {
            if (!db) { showToast("Offline Mode: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", true); return; }
            if (!isFirebaseReady || !currentUser) return;
            
            const container = document.getElementById('savedListContainer');
            container.innerHTML = '<p class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';
            
            try {
                // Use modular query and getDocs
                const userQuotesCollection = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'quotations');
                // IMPORTANT: Avoid using orderBy as it might require indexing. Fetch all and sort in memory.
                const q = query(userQuotesCollection);
                const snap = await getDocs(q);
                
                const docs = snap.docs.map(d => ({id: d.id, ...d.data()}))
                    // Sort by timestamp in memory (most recent first)
                    .sort((a, b) => (b.createdAt?.toDate().getTime() || 0) - (a.createdAt?.toDate().getTime() || 0));
                
                container.innerHTML = docs.length ? '' : '<p class="text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>';
                docs.forEach(doc => {
                    const div = document.createElement('div');
                    div.className = 'bg-white p-4 rounded border flex justify-between items-center';
                    const date = doc.createdAt?.toDate() ? doc.createdAt.toDate().toLocaleDateString('th-TH') : 'N/A';
                    div.innerHTML = `<div><h4 class="font-bold">${doc.title}</h4><p class="text-xs text-gray-500">${date} | ${doc.subtotal.toLocaleString('th-TH', { minimumFractionDigits: 2 })} ‡∏ö.</p></div>
                        <div class="gap-2 flex"><button onclick='loadQuotation("${doc.id}")' class="bg-indigo-100 text-indigo-700 px-3 rounded text-sm">‡πÇ‡∏´‡∏•‡∏î</button><button onclick='delQuotation("${doc.id}")' class="bg-red-100 text-red-700 px-3 rounded text-sm">‡∏•‡∏ö</button></div>`;
                    div.dataset.json = JSON.stringify(doc);
                    container.appendChild(div);
                });
            } catch (e) { 
                console.error("Fetch Error:", e);
                container.innerHTML = '<p class="text-center text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>'; 
            }
        }
        
        function openSavedListModal() {
            document.getElementById('savedListModal').style.display = 'flex';
            fetchSavedQuotations();
        }

        function loadQuotation(id) {
            // Find the element data
            const el = Array.from(document.getElementById('savedListContainer').children).find(e => e.dataset.json && JSON.parse(e.dataset.json).id === id);
            if(!el) return;
            const data = JSON.parse(el.dataset.json);
            if(!confirm(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "${data.title}"?`)) return;
            
            // Restore Values
            ['sellerName','sellerInfo','sellerTaxId','customerName','customerAddress','quotationDate','paymentDetail','bankName','accountNumber','accountName'].forEach(k => document.getElementById(k).value = data[k]||'');
            if(data.vatOption) document.getElementsByName('quotationVatOption').forEach(r => r.checked = r.value === data.vatOption);
            if(data.customCodes) { document.getElementById('product-code-1').value = data.customCodes[1]||''; document.getElementById('product-code-2').value = data.customCodes[2]||''; }
            
            // Clear current items
            document.getElementById('product-items-1').innerHTML = '';
            document.getElementById('product-items-2').innerHTML = '';
            
            // Restore Items
            const restoredItems = data.items.length ? data.items : [{productId:1},{productId:2}];
            restoredItems.forEach(i => {
                const raw = i.raw || { qty: i.qty, price: i.unitPrice };
                // Use existing structure, but make sure to pass productId correctly
                const pid = i.productId || (i.name.includes('PVC') ? 1 : 2);
                addItemRow(pid, false, {...raw, force: true});
            });
            
            // If the restored list was empty, re-add one initial row per product type
            if (!data.items.length) {
                addItemRow(1, true);
                addItemRow(2, true);
            }

            calculateQuotationTotal();
            closeModal(null, 'savedList');
        }

        async function delQuotation(id) {
            if (!isFirebaseReady || !currentUser) return;
            if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?')) {
                try {
                    const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'quotations', id);
                    await deleteDoc(docRef);
                    showToast("‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                    fetchSavedQuotations(); // Refresh list
                } catch (e) {
                    console.error("Delete Error:", e);
                    showToast("‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", true);
                }
            }
        }

        // --- 7. AI ASSISTANCE (Gemini) ---
        async function generatePaymentDetails() {
            const paymentDetailEl = document.getElementById('paymentDetail');
            const btn = document.getElementById('generatePaymentBtn');
            const originalHtml = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...';
            paymentDetailEl.placeholder = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô...';

            // Get total price to prompt the model
            const subtotal = document.getElementById('quotationSubtotalDisplay').textContent.replace(/,/g, '');

            const systemPrompt = "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ ‡∏à‡∏á‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ‡πÄ‡∏ä‡πà‡∏ô '‡∏°‡∏±‡∏î‡∏à‡∏≥ 50% ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 50% ‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå'";
            const userPrompt = `‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ñ‡∏∑‡∏≠ ${subtotal} ‡∏ö‡∏≤‡∏ó ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏î‡∏Å‡∏∏‡∏°`;

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    paymentDetailEl.value = generatedText.trim();
                } else {
                    console.error('Gemini API returned no text.', result);
                    showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', true);
                }

            } catch (error) {
                console.error('Error generating payment details:', error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API', true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
                paymentDetailEl.placeholder = '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏ä‡πà‡∏ô: ‡∏ä‡∏≥‡∏£‡∏∞ 50% ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤, ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á)';
            }
        }


        // --- 8. DOCUMENT GENERATION (Unchanged from previous file) ---
        function createQuotationHtml(data) {
            const items = data.items.filter(i => i.qty > 0 && i.unitPrice > 0);
            const rows = items.map((i,x) => `<tr class="h-10 text-sm"><td class="border px-3 text-center">${x+1}</td><td class="border px-3 font-semibold">${i.name} <span class="text-xs text-gray-500">(${i.code})</span></td><td class="border px-3">${i.description}</td><td class="border px-3 text-center">${i.qty}</td><td class="border px-3 text-center">‡∏ä‡∏∏‡∏î</td><td class="border px-3 text-right">${i.unitPrice.toLocaleString('th-TH',{minimumFractionDigits:2})}</td><td class="border px-3 text-right font-bold">${i.total.toLocaleString('th-TH',{minimumFractionDigits:2})}</td></tr>`).join('');
            const vat = data.vatOption === 'include' ? data.subtotal * 0.07 : 0;
            return `<div class="space-y-6 text-gray-800" style="font-family:'Sarabun'"><header class="text-center border-b-2 border-gray-800 pb-4"><h1 class="text-3xl font-bold">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (QUOTATION)</h1><p class="text-xl">${data.sellerName}</p><p class="text-sm whitespace-pre-wrap">${data.sellerInfo}</p></header>
                <div class="flex justify-between text-sm"><div class="w-1/2 border p-2 rounded"><p><strong>‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</strong> ${data.customerName}</p><p>${data.customerAddress}</p></div><div class="w-1/3 pl-4"><p><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</strong> QUO-${new Date().toISOString().slice(0,10).replace(/-/g,'')}</p><p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${new Date(data.quotationDate).toLocaleDateString('th-TH')}</p></div></div>
                <table class="w-full border-collapse"><thead><tr class="bg-gray-100 text-sm font-bold h-12"><td class="border px-3">#</td><td class="border px-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td><td class="border px-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</td><td class="border px-3 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</td><td class="border px-3 text-center">‡∏´‡∏ô‡πà‡∏ß‡∏¢</td><td class="border px-3 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</td><td class="border px-3 text-right">‡∏£‡∏ß‡∏°</td></tr></thead><tbody>${rows}${'<tr><td class="border h-10"></td><td class="border"></td><td class="border"></td><td class="border"></td><td class="border"></td><td class="border"></td><td class="border"></td></tr>'.repeat(Math.max(0,5-items.length))}</tbody></table>
                <div class="flex justify-between"><div class="w-3/5 pr-4 space-y-2"><div class="border p-3 rounded"><p class="font-bold text-indigo-700">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</p><p class="text-sm">${data.paymentDetail}</p></div><div class="border p-3 rounded bg-gray-50"><p class="font-bold">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</p><p class="text-sm">${data.bankName} ${data.accountNumber} (${data.accountName})</p></div></div><div class="w-2/5 border"><div class="flex justify-between p-2 border-b"><span class="text-sm">‡∏£‡∏ß‡∏°</span><span>${data.subtotal.toLocaleString('th-TH',{minimumFractionDigits:2})}</span></div>${vat>0?`<div class="flex justify-between p-2 border-b"><span class="text-sm">VAT 7%</span><span>${vat.toLocaleString('th-TH',{minimumFractionDigits:2})}</span></div>`:''}<div class="flex justify-between p-2 bg-gray-200"><span class="font-bold">‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span class="font-bold text-red-600">${(data.subtotal+vat).toLocaleString('th-TH',{minimumFractionDigits:2})}</span></div></div></div>
                <div class="flex justify-between pt-10 text-sm"><div class="w-5/12 text-center border-t pt-2">‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</div><div class="w-5/12 text-center border-t pt-2">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div></div></div>`;
        }

        function createReceiptHtml(data) {
            const items = document.querySelectorAll('#receiptItemTableBody tr');
            const rows = Array.from(items).map((r,i) => `<tr class="h-8 text-sm"><td class="border px-3 text-center">${i+1}</td><td class="border px-3">${r.querySelector('.item-description').value}</td><td class="border px-3 text-right">${r.querySelector('.item-quantity').value}</td><td class="border px-3 text-right">${parseFloat(r.querySelector('.item-price').value).toLocaleString('th-TH',{minimumFractionDigits:2})}</td><td class="border px-3 text-right font-bold">${r.querySelector('.item-total').textContent}</td></tr>`).join('');
            const sub = Array.from(items).reduce((s,r) => s + parseFloat(r.querySelector('.item-total').textContent.replace(/,/g,'')), 0);
            const isVat = document.querySelector('input[name="receiptVatOption"]:checked').value === 'include';
            const vat = isVat ? sub * 0.07 : 0;
            return `<div class="space-y-6 text-gray-800" style="font-family:'Sarabun'"><header class="text-center border-b-2 border-gray-800 pb-4"><h1 class="text-3xl font-bold">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h1><p class="text-xl">${data.sellerName}</p><p class="text-sm">${data.sellerInfo}</p><p class="text-sm">TAX: ${data.sellerTaxId}</p></header>
                <div class="flex justify-between text-sm"><div class="w-1/2 border p-2 rounded"><p>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${data.rCustomerName}</p><p>${data.rCustomerAddress}</p><p>TAX: ${data.rCustomerTaxId}</p></div><div class="w-1/3 pl-4"><p>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${data.receiptNo}</p><p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date(data.receiptDate).toLocaleDateString('th-TH')}</p><p>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞: ${data.paymentMethod}</p></div></div>
                <table class="w-full border-collapse"><thead><tr class="bg-gray-100 text-sm font-bold h-10"><td class="border px-3">#</td><td class="border px-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td><td class="border px-3 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</td><td class="border px-3 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤</td><td class="border px-3 text-right">‡∏£‡∏ß‡∏°</td></tr></thead><tbody>${rows}${'<tr><td class="border h-8"></td><td class="border"></td><td class="border"></td><td class="border"></td><td class="border"></td></tr>'.repeat(Math.max(0,5-items.length))}</tbody></table>
                <div class="flex justify-end pt-4"><div class="w-2/5 border"><div class="flex justify-between p-2 border-b"><span>‡∏£‡∏ß‡∏°</span><span>${sub.toLocaleString('th-TH',{minimumFractionDigits:2})}</span></div>${isVat?`<div class="flex justify-between p-2 border-b"><span>VAT 7%</span><span>${vat.toLocaleString('th-TH',{minimumFractionDigits:2})}</span></div>`:''}<div class="flex justify-between p-2 bg-gray-200"><span class="font-bold">‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span class="font-bold text-blue-600">${(sub+vat).toLocaleString('th-TH',{minimumFractionDigits:2})}</span></div></div></div>
                <div class="flex justify-between pt-10 text-sm"><div class="w-5/12 text-center border-t pt-2">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div><div class="w-5/12 text-center border-t pt-2">‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</div></div></div>`;
        }

        // Functions for button clicks (Generate, Populate, etc)
        function generateQuotation() {
            const data = getQuotationFormData();
            if(data.items.filter(i=>i.qty>0&&i.unitPrice>0).length===0) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö', true); return; }
            document.getElementById('quotation-output').innerHTML = createQuotationHtml(data);
            document.getElementById('quotationModal').style.display = 'flex';
        }
        function populateReceiptFromQuotation() {
            const data = getQuotationFormData();
            const valid = data.items.filter(i=>i.qty>0&&i.unitPrice>0);
            if(!valid.length) { showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤', true); return; }
            document.getElementById('receiptItemTableBody').innerHTML = '';
            receiptItemCounter = 0;
            valid.forEach(i => addItemRowReceipt(i.description, i.qty, i.unitPrice));
            if(data.vatOption) document.getElementsByName('receiptVatOption').forEach(r => r.checked = r.value===data.vatOption);
            syncCustomerInfoToReceipt();
            calculateReceiptTotals();
        }
        function generateReceipt() {
            const data = { sellerName:document.getElementById('sellerName').value, sellerInfo:document.getElementById('sellerInfo').value, sellerTaxId:document.getElementById('sellerTaxId').value, rCustomerName:document.getElementById('rCustomerName').value, rCustomerAddress:document.getElementById('rCustomerAddress').value, rCustomerTaxId:document.getElementById('rCustomerTaxId').value, receiptNo:document.getElementById('receiptNo').value, receiptDate:document.getElementById('receiptDate').value, paymentMethod:document.getElementById('paymentMethod').value };
            if(document.querySelectorAll('#receiptItemTableBody tr').length === 0) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô', true); return; }
            document.getElementById('receipt-output').innerHTML = createReceiptHtml(data);
            document.getElementById('receiptModal').style.display = 'flex';
        }
        function addItemRowReceipt(desc='', qty=1, price=0) {
            receiptItemCounter++;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="px-3 py-2 text-center text-gray-500">${receiptItemCounter}</td><td class="px-6 py-2"><input class="w-full item-description p-1 border rounded" value="${desc}"></td><td class="px-6 py-2"><input type="number" class="w-full item-quantity p-1 border rounded text-right" value="${qty}" oninput="calculateReceiptTotals()"></td><td class="px-6 py-2"><input type="number" class="w-full item-price p-1 border rounded text-right" value="${price}" oninput="calculateReceiptTotals()"></td><td class="px-6 py-2 text-right item-total font-semibold">0.00</td><td class="no-print px-1 text-center"><button class="text-red-500" onclick="this.closest('tr').remove();reindexReceiptRows();calculateReceiptTotals()">‡∏•‡∏ö</button></td>`;
            document.getElementById('receiptItemTableBody').appendChild(tr);
            calculateReceiptTotals();
        }
        function reindexReceiptRows() { receiptItemCounter=0; document.querySelectorAll('#receiptItemTableBody tr td:first-child').forEach(td => td.textContent = ++receiptItemCounter); }

        function downloadPDF(type) {
            const id = type==='quotation'?'quotation-output':'receipt-output';
            const pdf = new window.jspdf.jsPDF('p','pt','a4');
            html2canvas(document.getElementById(id), {scale:2, scrollY:-window.scrollY}).then(c => {
                pdf.addImage(c.toDataURL('image/jpeg'), 'JPEG', 0, 0, pdf.internal.pageSize.getWidth(), (c.height*pdf.internal.pageSize.getWidth())/c.width);
                pdf.save(`${type}.pdf`);
            });
        }
        function captureScreen(type) {
            html2canvas(document.getElementById(type==='quotation'?'quotation-output':'receipt-output'), {scale:2, scrollY:-window.scrollY}).then(c => c.toBlob(b => navigator.clipboard.write([new ClipboardItem({"image/png":b})]).then(()=> { document.getElementById(type+'CopyMessage').classList.remove('hidden'); setTimeout(()=>document.getElementById(type+'CopyMessage').classList.add('hidden'),3000); })));
        }

        // --- 9. INITIALIZATION ---
        // Initialize Rows
        addItemRow(1, true);
        addItemRow(2, true);
        addItemRowReceipt('‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', 1, 0);

        // Set today's date
        document.getElementById('quotationDate').valueAsDate = new Date();
        document.getElementById('receiptDate').valueAsDate = new Date();

    </script>
</body>
</html>
