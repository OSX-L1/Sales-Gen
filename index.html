<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ & ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à) + ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</title>
    
    <!-- ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ‡πÇ‡∏´‡∏•‡∏î Google Font Sarabun TH -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <!-- ‡πÇ‡∏´‡∏•‡∏î Library ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PDF/Capture -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- ‡πÇ‡∏´‡∏•‡∏î Firebase SDK (Modular ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô Compat ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        
        /* Style ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ A4 */
        #quotation-output, #receipt-output {
            background-color: white;
            padding: 2.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            min-height: 1123px; width: 794px; margin: auto;
        }
        
        @media print {
            .modal-hidden-on-print, .no-print { display: none !important; }
            .page-container { box-shadow: none !important; margin: 0 !important; }
        }

        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .active-tab { background-color: #4f46e5; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .inactive-tab { background-color: #eef2ff; color: #4f46e5; border: 1px solid #c7d2fe; }
        .inactive-tab:hover { background-color: #e0e7ff; }

        /* Loading Overlay */
        #loadingOverlay {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="p-4 md:p-8 relative">

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 right-5 z-[100] bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full opacity-0 flex items-center">
        <span id="toastMessage">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 z-[90] hidden items-center justify-center">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10 text-indigo-600 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-indigo-800 font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</span>
        </div>
    </div>

    <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-2 text-center">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h1>
        <p class="text-center text-gray-500 mb-6 text-sm">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</p>
        
        <!-- Main Navigation -->
        <div class="no-print flex flex-wrap justify-center gap-3 mb-8 border-b-2 pb-4">
            <button onclick="switchView('quotation')" id="btnQuotation" class="px-6 py-2 rounded-lg font-bold transition duration-150 active-tab">
                üìù ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
            </button>
            <button onclick="switchView('receipt')" id="btnReceipt" class="px-6 py-2 rounded-lg font-bold transition duration-150 inactive-tab">
                üßæ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô
            </button>
            
            <!-- Cloud Actions -->
            <div class="flex gap-2 ml-0 md:ml-4 border-l-2 pl-4 border-gray-200">
                <button onclick="saveQuotationToCloud()" class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-bold shadow-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
                <button onclick="openSavedListModal()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-bold shadow-sm flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (Load)
                </button>
            </div>
        </div>

        <!-- 0. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ -->
        <section class="mb-6 p-4 border border-blue-200 rounded-lg bg-blue-50 no-print">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold text-blue-700">0. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)</h2>
                <button onclick="toggleSection('sellerSection')" class="text-blue-500 text-sm hover:underline">‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á</button>
            </div>
            <div id="sellerSection">
                <input id="sellerName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢)" value="‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏à‡∏≥‡∏Å‡∏±‡∏î" class="w-full p-3 mb-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150">
                <textarea id="sellerInfo" rows="2" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà, ‡πÄ‡∏•‡∏Ç‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ, ‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå ‡∏Ø‡∏•‡∏Ø" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150">99/9 ‡∏´‡∏°‡∏π‡πà 9 ‡∏ñ‡∏ô‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏ï‡∏≥‡∏ö‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 10000</textarea>
                <input type="text" id="sellerTaxId" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ (‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à)" value="1234567890123" class="w-full mt-2 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-150">
            </div>
        </section>

        <!-- ========================================================================= -->
        <!-- VIEW 1: QUOTATION FORM (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤) -->
        <!-- ========================================================================= -->
        <div id="quotationView" class="view-content">
            
            <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö -->
            <section class="mb-8 p-4 border border-indigo-200 rounded-lg bg-indigo-50">
                <h2 class="text-xl font-semibold text-indigo-700 mb-4">1. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h2>
                <div class="space-y-4">
                    <input id="customerName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition duration-150">
                    <textarea id="customerAddress" rows="3" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition duration-150"></textarea>
                    <input id="quotationDate" type="date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition duration-150" required>
                </div>
            </section>

            <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
            <section class="mb-8 p-4 border border-green-200 rounded-lg bg-green-50">
                <h2 class="text-xl font-semibold text-green-700 mb-4">2. ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤</h2>
                
                <div id="productContainer" class="space-y-8">
                    <!-- ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ 1: ‡∏â‡∏≤‡∏Å‡∏Å‡∏±‡πâ‡∏ô PVC -->
                    <div id="product-1" class="p-4 border border-green-300 rounded-lg bg-white shadow-md">
                        <h3 class="font-bold text-xl text-green-600 mb-1 flex items-center flex-wrap gap-2">
                            ‡∏â‡∏≤‡∏Å‡∏Å‡∏±‡πâ‡∏ô PVC 
                            <span class="text-gray-500 text-lg font-normal flex items-center">
                                (‡∏£‡∏´‡∏±‡∏™ <input type="text" id="product-code-1" value="SN390-10" class="mx-1 p-1 border border-green-300 rounded text-sm w-28 text-green-700 focus:ring-2 focus:ring-green-500 outline-none bg-green-50">)
                            </span>
                        </h3>
                        <p class="text-sm text-gray-500 mb-3">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ‡∏Ç‡∏ô‡∏≤‡∏î ‡∏Å‡∏ß‡πâ‡∏≤‡∏á x ‡∏™‡∏π‡∏á, ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á/‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡∏≤‡∏á</p>
                        <div id="product-items-1" class="space-y-4 mb-4"></div>
                        <button type="button" onclick="addItemRow(1)" class="w-full py-2 bg-green-100 text-green-700 font-semibold rounded-lg hover:bg-green-200 border-dashed border-2 border-green-300">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏â‡∏≤‡∏Å‡∏Å‡∏±‡πâ‡∏ô PVC</button>
                    </div>

                    <!-- ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ 2: ‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô Blackout -->
                    <div id="product-2" class="p-4 border border-green-300 rounded-lg bg-white shadow-md">
                        <h3 class="font-bold text-xl text-green-600 mb-1 flex items-center flex-wrap gap-2">
                            ‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô Blackout 
                            <span class="text-gray-500 text-lg font-normal flex items-center">
                                (‡∏£‡∏´‡∏±‡∏™ <input type="text" id="product-code-2" value="RBP-3901" class="mx-1 p-1 border border-green-300 rounded text-sm w-28 text-green-700 focus:ring-2 focus:ring-green-500 outline-none bg-green-50">)
                            </span>
                        </h3>
                        <p class="text-sm text-gray-500 mb-3">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: ‡∏Ç‡∏ô‡∏≤‡∏î ‡∏Å‡∏ß‡πâ‡∏≤‡∏á x ‡∏™‡∏π‡∏á, ‡∏õ‡∏£‡∏±‡∏ö‡∏ã‡πâ‡∏≤‡∏¢/‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ß‡∏≤</p>
                        <div id="product-items-2" class="space-y-4 mb-4"></div>
                        <button type="button" onclick="addItemRow(2)" class="w-full py-2 bg-green-100 text-green-700 font-semibold rounded-lg hover:bg-green-200 border-dashed border-2 border-green-300">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô Blackout</button>
                    </div>
                </div>
                
                <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å VAT -->
                <div class="mt-6 p-4 rounded-lg bg-green-100">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-4">
                        <div class="bg-white p-3 rounded-lg border border-green-300 shadow-sm w-full md:w-auto">
                            <span class="font-bold text-gray-700 block mb-2">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏©‡∏µ (VAT 7%):</span>
                            <div class="flex space-x-4">
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="radio" name="quotationVatOption" value="include" class="form-radio text-green-600 w-5 h-5" checked>
                                    <span class="ml-2 text-gray-800">‡∏Ñ‡∏¥‡∏î VAT (+7%)</span>
                                </label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="radio" name="quotationVatOption" value="none" class="form-radio text-green-600 w-5 h-5">
                                    <span class="ml-2 text-gray-800">‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î VAT</span>
                                </label>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-bold text-gray-800">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: <span id="quotationSubtotalDisplay" class="text-red-600">0.00</span> ‡∏ö‡∏≤‡∏ó</p>
                            <small class="text-gray-600">* ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ (Subtotal)</small>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
            <section class="mb-8 p-4 border border-yellow-200 rounded-lg bg-yellow-50">
                <h2 class="text-xl font-semibold text-yellow-700 mb-4">3. ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>
                <div class="flex justify-end mb-3">
                    <button id="generatePaymentBtn" onclick="generatePaymentDetails()" class="flex items-center space-x-2 bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2 px-4 rounded-lg transition duration-150 transform hover:scale-[1.02] shadow-md">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zM8.32 14.28a1 1 0 01-1.41 1.41A6 6 0 1113 7.64a1 1 0 011.85-.75l.17.42A8 8 0 1010 18a8 8 0 000-16zm.18-1.42a1 1 0 00-.81.25l-.23.23a1 1 0 00.7.35l.11-.01.1-.03a1 1 0 00.7-.35zM9 10a1 1 0 100-2 1 1 0 000 2z"/></svg>
                        <span>‚ú® ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (AI)</span>
                    </button>
                </div>
                <div class="space-y-3">
                    <textarea id="paymentDetail" rows="2" placeholder="‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (‡πÄ‡∏ä‡πà‡∏ô: ‡∏°‡∏±‡∏î‡∏à‡∏≥ 50%)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 transition duration-150"></textarea>
                    <input id="bankName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 transition duration-150">
                    <input id="accountNumber" type="text" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 transition duration-150">
                    <input id="accountName" type="text" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 transition duration-150">
                </div>
            </section>

            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ -->
            <div class="flex justify-center">
                <button onclick="generateQuotation()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-xl transition duration-300 shadow-lg hover:shadow-xl transform hover:scale-105 active:scale-100">
                    ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (Preview)
                </button>
            </div>
        </div>

        <!-- ========================================================================= -->
        <!-- VIEW 2: RECEIPT FORM (‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô) -->
        <!-- ========================================================================= -->
        <div id="receiptView" class="view-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <h3 class="font-semibold mb-2 text-blue-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                    <input type="text" id="rCustomerName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô" class="w-full mb-2 p-2 border rounded-lg">
                    <textarea id="rCustomerAddress" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤" class="w-full p-2 border rounded-lg resize-none h-12"></textarea>
                    <input type="text" id="rCustomerTaxId" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" class="w-full mt-2 p-2 border rounded-lg">
                </div>
                <div class="bg-gray-50 p-4 rounded-lg border flex flex-col justify-between">
                    <div>
                        <h3 class="font-semibold mb-2 text-blue-600">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</h3>
                        <div class="flex justify-between mb-2">
                            <label class="font-medium text-gray-700 w-1/3">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</label>
                            <input type="text" id="receiptNo" value="REC-202410-001" class="w-2/3 p-2 border rounded-lg text-right">
                        </div>
                        <div class="flex justify-between mb-2">
                            <label class="font-medium text-gray-700 w-1/3">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                            <input type="date" id="receiptDate" class="w-2/3 p-2 border rounded-lg text-right">
                        </div>
                        <div class="flex justify-between">
                            <label class="font-medium text-gray-700 w-1/3">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞:</label>
                            <select id="paymentMethod" class="w-2/3 p-2 border rounded-lg bg-white text-right">
                                <option value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                                <option value="‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</option>
                                <option value="‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="no-print flex justify-end mb-4">
                <button onclick="populateReceiptFromQuotation()" class="flex items-center space-x-2 bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg shadow-md">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M15.312 11.424a1.05 1.05 0 01-.06 1.06l-1.636 1.73a.87.87 0 00-.21 1.077c.433.864.137 2.01-.727 2.443L9.61 18.995c-1.488.744-3.328-.31-3.665-1.928l-.055-.251c-.125-.63.26-1.25.89-1.375l2.497-.499a.87.87 0 00.707-.29l1.96-2.185a1.5 1.5 0 000-2.072l-1.96-2.185a.87.87 0 00-.707-.29l-2.497-.499c-.63-.125-1.015-.745-.89-1.375l.056-.251c.337-1.618 2.177-2.672 3.665-1.928l4.08 2.04c.864.433 1.16 1.579.727 2.443a.87.87 0 00-.21 1.077l1.636 1.73a1.05 1.05 0 01-.06 1.06z" clip-rule="evenodd" /></svg>
                    <span>‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</span>
                </button>
            </div>
            
            <div class="overflow-x-auto mb-6">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider w-1/12">#</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider w-5/12">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider w-2/12">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider w-2/12">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider w-2/12">‡∏£‡∏ß‡∏°</th>
                            <th class="px-1 py-3 w-1/12 no-print"></th>
                        </tr>
                    </thead>
                    <tbody id="receiptItemTableBody" class="bg-white divide-y divide-gray-100 text-sm"></tbody>
                </table>
            </div>
            
            <div class="flex justify-end mb-4 no-print">
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-200 shadow-sm">
                    <span class="font-bold text-gray-700 block mb-2 text-sm">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏©‡∏µ (VAT 7%):</span>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="receiptVatOption" value="include" class="form-radio text-blue-600 w-4 h-4" checked onchange="calculateReceiptTotals()">
                            <span class="ml-2 text-gray-800 text-sm">‡∏Ñ‡∏¥‡∏î VAT (+7%)</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="radio" name="receiptVatOption" value="none" class="form-radio text-blue-600 w-4 h-4" onchange="calculateReceiptTotals()">
                            <span class="ml-2 text-gray-800 text-sm">‡πÑ‡∏°‡πà‡∏Ñ‡∏¥‡∏î VAT</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="no-print mt-6 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button onclick="addItemRowReceipt('', 1, 0)" class="px-6 py-3 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (Manual)</button>
                <button onclick="generateReceipt()" class="px-8 py-3 bg-blue-600 text-white text-lg font-bold rounded-lg shadow-xl hover:bg-blue-700">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</button>
            </div>
        </div>
    </div>

    <!-- Modal: Saved Quotations List -->
    <div id="savedListModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-2xl font-bold text-gray-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (Cloud)</h3>
                <button onclick="closeModal(null, 'savedList')" class="text-gray-500 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <div id="savedListContainer" class="p-6 overflow-y-auto flex-1 space-y-2 bg-gray-50">
                <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                <p class="text-center text-gray-500 mt-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
        </div>
    </div>

    <!-- Modal: Preview Quotation -->
    <div id="quotationModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50 overflow-y-auto" onclick="closeModal(event, 'quotation')">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl my-8" onclick="event.stopPropagation()">
            <div class="modal-hidden-on-print flex justify-between items-center p-4 bg-indigo-50 rounded-t-xl border-b">
                <h3 class="text-2xl font-bold text-indigo-800">‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h3>
                <button onclick="closeModal(null, 'quotation')" class="text-gray-600 hover:text-red-500 text-3xl">&times;</button>
            </div>
            <div id="quotationPreview" class="p-2 overflow-y-auto max-h-[85vh]">
                <div id="quotation-output"></div>
            </div>
            <div class="modal-hidden-on-print p-4 border-t bg-indigo-50 rounded-b-xl flex justify-center gap-4">
                <button onclick="downloadPDF('quotation')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">‚¨áÔ∏è PDF</button>
                <button onclick="captureScreen('quotation')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">üì∑ Copy Image</button>
                <div id="quotationCopyMessage" class="hidden text-sm text-green-700 font-medium self-center">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!</div>
            </div>
        </div>
    </div>

    <!-- Modal: Preview Receipt -->
    <div id="receiptModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50 overflow-y-auto" onclick="closeModal(event, 'receipt')">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl my-8" onclick="event.stopPropagation()">
            <div class="modal-hidden-on-print flex justify-between items-center p-4 bg-blue-50 rounded-t-xl border-b">
                <h3 class="text-2xl font-bold text-blue-800">‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
                <button onclick="closeModal(null, 'receipt')" class="text-gray-600 hover:text-red-500 text-3xl">&times;</button>
            </div>
            <div id="receiptPreview" class="p-2 overflow-y-auto max-h-[85vh]">
                <div id="receipt-output"></div>
            </div>
            <div class="modal-hidden-on-print p-4 border-t bg-blue-50 rounded-b-xl flex justify-center gap-4">
                <button onclick="downloadPDF('receipt')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">‚¨áÔ∏è PDF</button>
                <button onclick="captureScreen('receipt')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">üì∑ Copy Image</button>
                <div id="receiptCopyMessage" class="hidden text-sm text-green-700 font-medium self-center">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!</div>
            </div>
        </div>
    </div>

    <script>
        // --- Firebase Setup ---
        // Import the functions you need from the SDKs you need

import { initializeApp } from "firebase/app";

import { getAnalytics } from "firebase/analytics";

// TODO: Add SDKs for Firebase products that you want to use

// https://firebase.google.com/docs/web/setup#available-libraries



// Your web app's Firebase configuration

// For Firebase JS SDK v7.20.0 and later, measurementId is optional

const firebaseConfig = {

  apiKey: "AIzaSyDfFpkzO6vSHmm6TZ7I3VKPKBvnLOg3XcA",

  authDomain: "sale-gen.firebaseapp.com",

  projectId: "sale-gen",

  storageBucket: "sale-gen.firebasestorage.app",

  messagingSenderId: "757138360758",

  appId: "1:757138360758:web:029cd6806a260e94619917",

  measurementId: "G-EK7T3QF1C9"

};



// Initialize Firebase

const app = initializeApp(firebaseConfig);

const analytics = getAnalytics(app);
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let currentUser = null;

        // Authentication Anonymous
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                console.log("Signed in as:", user.uid);
            } else {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    auth.signInWithCustomToken(__initial_auth_token).catch(e => console.error(e));
                } else {
                    auth.signInAnonymously().catch(e => console.error("Auth failed:", e));
                }
            }
        });

        // --- App Logic ---
        const products = {
            1: { id: 1, name: '‡∏â‡∏≤‡∏Å‡∏Å‡∏±‡πâ‡∏ô PVC', code: 'SN390-10', option1: '‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡πâ‡∏≤‡∏á', option2: '‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡∏≤‡∏á' },
            2: { id: 2, name: '‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô Blackout', code: 'RBP-3901', option1: '‡∏õ‡∏£‡∏±‡∏ö‡∏ã‡πâ‡∏≤‡∏¢', option2: '‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ß‡∏≤' }
        };

        let nextRowId = 1;
        let receiptItemCounter = 0;

        // --- UI Utilities ---
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toastMessage');
            msg.textContent = message;
            toast.classList.remove('bg-gray-800', 'bg-red-600', 'translate-x-full', 'opacity-0');
            toast.classList.add(isError ? 'bg-red-600' : 'bg-gray-800', 'translate-x-0', 'opacity-100');
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                toast.classList.remove('translate-x-0', 'opacity-100');
            }, 3000);
        }

        function switchView(viewName) {
            const views = { quotation: 'quotationView', receipt: 'receiptView' };
            const buttons = { quotation: 'btnQuotation', receipt: 'btnReceipt' };
            
            for (const key in views) {
                const el = document.getElementById(views[key]);
                const btn = document.getElementById(buttons[key]);
                if (key === viewName) {
                    el.classList.remove('hidden');
                    btn.classList.add('active-tab');
                    btn.classList.remove('inactive-tab');
                    if (viewName === 'receipt') syncCustomerInfoToReceipt();
                } else {
                    el.classList.add('hidden');
                    btn.classList.remove('active-tab');
                    btn.classList.add('inactive-tab');
                }
            }
        }

        function toggleSection(id) {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
        }

        function syncCustomerInfoToReceipt() {
            document.getElementById('rCustomerName').value = document.getElementById('customerName').value;
            document.getElementById('rCustomerAddress').value = document.getElementById('customerAddress').value;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('quotationDate').value = today;
            document.getElementById('receiptDate').value = today;
            // Init rows
            addItemRow(1, true);
            addItemRow(2, true);
            addItemRowReceipt('‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', 1, 1000.00);
        });

        function closeModal(event, type) {
            const ids = { quotation: 'quotationModal', receipt: 'receiptModal', savedList: 'savedListModal' };
            const modalId = ids[type];
            if (!event || event.target.id === modalId) {
                document.getElementById(modalId).style.display = 'none';
            }
        }

        function openSavedListModal() {
            document.getElementById('savedListModal').style.display = 'flex';
            fetchSavedQuotations();
        }

        // --- Quotation Logic ---
        function createProductRowHtml(productId, rowId, initialValues = {}) {
            const p = products[productId];
            const isInitial = document.getElementById(`product-items-${productId}`).childElementCount === 0 && !initialValues.force;
            
            const width = initialValues.width || '';
            const height = initialValues.height || '';
            const qty = initialValues.qty || 1;
            const price = initialValues.price || '';
            const option = initialValues.option || p.option1;

            return `
                <div id="item-row-${rowId}" data-product-id="${productId}" class="grid grid-cols-6 gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200 items-center mb-2">
                    <input type="number" data-field="width" placeholder="‡∏Å‡∏ß‡πâ‡∏≤‡∏á (‡∏ã‡∏°.)" value="${width}" class="col-span-2 md:col-span-1 p-2 border rounded-lg" onchange="calculateQuotationTotal()">
                    <input type="number" data-field="height" placeholder="‡∏™‡∏π‡∏á (‡∏ã‡∏°.)" value="${height}" class="col-span-2 md:col-span-1 p-2 border rounded-lg" onchange="calculateQuotationTotal()">
                    <select data-field="option" class="col-span-2 md:col-span-1 p-2 border rounded-lg" onchange="calculateQuotationTotal()">
                        <option value="${p.option1}" ${option === p.option1 ? 'selected' : ''}>${p.option1}</option>
                        <option value="${p.option2}" ${option === p.option2 ? 'selected' : ''}>${p.option2}</option>
                    </select>
                    <input type="number" data-field="qty" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" class="col-span-3 md:col-span-1 p-2 border rounded-lg" min="1" value="${qty}" onchange="calculateQuotationTotal()">
                    <input type="number" data-field="price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ä‡∏∏‡∏î" class="col-span-3 md:col-span-1 p-2 border rounded-lg" value="${price}" onchange="calculateQuotationTotal()">
                    <div class="col-span-6 md:col-span-1 flex justify-end">
                        <button type="button" onclick="removeRow(${rowId})" class="w-full md:w-auto p-2 text-sm bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150 ${isInitial ? 'opacity-0 pointer-events-none' : ''}">‡∏•‡∏ö</button>
                    </div>
                </div>
            `;
        }

        function addItemRow(productId, isInitialLoad = false, initialValues = {}) {
            const container = document.getElementById(`product-items-${productId}`);
            const newRowId = nextRowId++;
            const newRowHtml = createProductRowHtml(productId, newRowId, initialValues);
            container.insertAdjacentHTML('beforeend', newRowHtml);
            if (!isInitialLoad) {
                calculateQuotationTotal();
                const newRowElement = document.getElementById(`item-row-${newRowId}`);
                if(newRowElement.querySelector('button')) newRowElement.querySelector('button').classList.remove('opacity-0', 'pointer-events-none');
            }
        }

        function removeRow(rowId) {
            const rowElement = document.getElementById(`item-row-${rowId}`);
            if (rowElement) {
                const productId = rowElement.getAttribute('data-product-id');
                rowElement.remove();
                if (document.getElementById(`product-items-${productId}`).childElementCount === 0) {
                     addItemRow(parseInt(productId), true);
                }
                calculateQuotationTotal();
            }
        }

        function calculateQuotationTotal() {
            let subtotal = 0;
            document.querySelectorAll('#productContainer [data-product-id]').forEach(rowEl => {
                const qty = parseFloat(rowEl.querySelector(`[data-field="qty"]`).value) || 0;
                const price = parseFloat(rowEl.querySelector(`[data-field="price"]`).value) || 0;
                subtotal += (qty * price);
            });
            document.getElementById('quotationSubtotalDisplay').textContent = subtotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            return subtotal;
        }

        // --- Data Handling (Save/Load) ---

        function getQuotationFormData() {
            const vatOption = document.querySelector('input[name="quotationVatOption"]:checked').value;
            
            // Get Custom Codes
            const code1 = document.getElementById('product-code-1').value;
            const code2 = document.getElementById('product-code-2').value;
            
            const data = {
                sellerName: document.getElementById('sellerName').value,
                sellerInfo: document.getElementById('sellerInfo').value,
                sellerTaxId: document.getElementById('sellerTaxId').value,
                customerName: document.getElementById('customerName').value,
                customerAddress: document.getElementById('customerAddress').value,
                quotationDate: document.getElementById('quotationDate').value,
                paymentDetail: document.getElementById('paymentDetail').value,
                bankName: document.getElementById('bankName').value,
                accountNumber: document.getElementById('accountNumber').value,
                accountName: document.getElementById('accountName').value,
                vatOption: vatOption,
                customCodes: { 1: code1, 2: code2 }, // Save custom codes
                items: []
            };

            document.querySelectorAll('#productContainer [data-product-id]').forEach(rowEl => {
                const productId = parseInt(rowEl.getAttribute('data-product-id'));
                const p = products[productId];
                const qty = parseFloat(rowEl.querySelector(`[data-field="qty"]`).value) || 0;
                const price = parseFloat(rowEl.querySelector(`[data-field="price"]`).value) || 0;
                const width = parseFloat(rowEl.querySelector(`[data-field="width"]`).value) || 0;
                const height = parseFloat(rowEl.querySelector(`[data-field="height"]`).value) || 0;
                const option = rowEl.querySelector(`[data-field="option"]`).value;
                
                // Use dynamic code
                const currentCode = document.getElementById(`product-code-${productId}`).value;

                // Save even if empty to restore state correctly, but only if meaningful
                if (true) { 
                     data.items.push({
                        productId: productId, // Important for restoring
                        name: p.name,
                        code: currentCode, // Save dynamic code
                        description: `${p.name} ${width > 0 && height > 0 ? '‡∏Ç‡∏ô‡∏≤‡∏î: ' + width + ' x ' + height + ' ‡∏ã‡∏°. ' : ''}(${option})`,
                        qty: qty,
                        unitPrice: price,
                        total: qty * price,
                        raw: { width, height, option, qty, price } // Save raw inputs
                    });
                }
            });

            data.subtotal = data.items.reduce((sum, item) => sum + item.total, 0);
            return data;
        }

        async function saveQuotationToCloud() {
            if (!currentUser) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...', true); return; }
            
            const name = prompt("‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤):", document.getElementById('customerName').value);
            if (name === null) return; // Cancelled

            showLoading(true);
            const formData = getQuotationFormData();
            const savePayload = {
                ...formData,
                title: name || '‡∏â‡∏ö‡∏±‡∏ö‡∏£‡πà‡∏≤‡∏á (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                userId: currentUser.uid
            };

            try {
                await db.collection('artifacts').doc(appId)
                        .collection('users').doc(currentUser.uid)
                        .collection('quotations').add(savePayload);
                showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            } catch (error) {
                console.error("Save error:", error);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', true);
            } finally {
                showLoading(false);
            }
        }

        async function fetchSavedQuotations() {
             if (!currentUser) return;
             const container = document.getElementById('savedListContainer');
             container.innerHTML = '<p class="text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>';

             try {
                 // No orderBy due to index limitations in instructions, sort in memory
                 const snapshot = await db.collection('artifacts').doc(appId)
                                          .collection('users').doc(currentUser.uid)
                                          .collection('quotations').get();
                
                 const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 // Sort by createdAt desc
                 docs.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                 if (docs.length === 0) {
                     container.innerHTML = '<p class="text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</p>';
                     return;
                 }

                 container.innerHTML = '';
                 docs.forEach(doc => {
                     const dateStr = doc.createdAt ? new Date(doc.createdAt.seconds * 1000).toLocaleDateString('th-TH') : '-';
                     const item = document.createElement('div');
                     item.className = 'bg-white p-4 rounded-lg border shadow-sm hover:shadow-md transition flex justify-between items-center';
                     item.innerHTML = `
                        <div>
                            <h4 class="font-bold text-gray-800">${doc.title}</h4>
                            <p class="text-xs text-gray-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${dateStr} | ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${doc.customerName || '-'}</p>
                            <p class="text-xs text-gray-500">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${doc.subtotal?.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="loadQuotationToForm('${doc.id}')" class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded hover:bg-indigo-200 text-sm font-bold">‡πÇ‡∏´‡∏•‡∏î</button>
                            <button onclick="deleteQuotation('${doc.id}')" class="bg-red-100 text-red-700 px-3 py-1 rounded hover:bg-red-200 text-sm">‡∏•‡∏ö</button>
                        </div>
                     `;
                     // Attach data to element to avoid re-fetching
                     item.dataset.jsonData = JSON.stringify(doc);
                     container.appendChild(item);
                 });

             } catch (error) {
                 console.error("Fetch error:", error);
                 container.innerHTML = '<p class="text-center text-red-500">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</p>';
             }
        }

        function loadQuotationToForm(docId) {
            // Find data in DOM to save a read
            const listContainer = document.getElementById('savedListContainer');
            const itemEl = Array.from(listContainer.children).find(el => el.querySelector(`button[onclick*="${docId}"]`));
            if (!itemEl) return;
            
            const data = JSON.parse(itemEl.dataset.jsonData);
            
            if (!confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "${data.title}" ‡∏°‡∏≤‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

            showLoading(true);
            try {
                // Restore standard fields
                document.getElementById('sellerName').value = data.sellerName || '';
                document.getElementById('sellerInfo').value = data.sellerInfo || '';
                document.getElementById('sellerTaxId').value = data.sellerTaxId || '';
                document.getElementById('customerName').value = data.customerName || '';
                document.getElementById('customerAddress').value = data.customerAddress || '';
                document.getElementById('quotationDate').value = data.quotationDate || '';
                document.getElementById('paymentDetail').value = data.paymentDetail || '';
                document.getElementById('bankName').value = data.bankName || '';
                document.getElementById('accountNumber').value = data.accountNumber || '';
                document.getElementById('accountName').value = data.accountName || '';

                // Restore VAT
                if (data.vatOption) {
                    const radios = document.getElementsByName('quotationVatOption');
                    radios.forEach(r => r.checked = (r.value === data.vatOption));
                }
                
                // Restore Custom Codes
                if (data.customCodes) {
                    if (data.customCodes[1]) document.getElementById('product-code-1').value = data.customCodes[1];
                    if (data.customCodes[2]) document.getElementById('product-code-2').value = data.customCodes[2];
                }

                // Restore Items
                // 1. Clear existing
                document.getElementById('product-items-1').innerHTML = '';
                document.getElementById('product-items-2').innerHTML = '';
                
                // 2. Add rows
                if (data.items && data.items.length > 0) {
                    data.items.forEach(item => {
                        // Use saved raw data or fallback
                        const initVals = item.raw || { width: '', height: '', qty: item.qty, price: item.unitPrice, option: '' };
                        // Force allow deletion even for first item if it comes from load
                        initVals.force = true; 
                        addItemRow(item.productId, false, initVals);
                    });
                } else {
                    // If no items saved, reset to defaults
                    addItemRow(1, true);
                    addItemRow(2, true);
                }

                closeModal(null, 'savedList');
                showToast('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            } catch (e) {
                console.error(e);
                showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î', true);
            } finally {
                showLoading(false);
            }
        }

        async function deleteQuotation(docId) {
            if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            showLoading(true);
            try {
                await db.collection('artifacts').doc(appId)
                        .collection('users').doc(currentUser.uid)
                        .collection('quotations').doc(docId).delete();
                fetchSavedQuotations(); // Reload list
                showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (e) {
                showToast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', true);
            } finally {
                showLoading(false);
            }
        }

        // --- Generate Output Logic ---
        function createQuotationHtml(data) {
            const formattedDate = new Date(data.quotationDate).toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' });
            
            // Filter only valid items (must have price > 0)
            const validItems = data.items.filter(i => i.qty > 0 && i.unitPrice > 0);
            
            let itemsHtml = '';
            validItems.forEach((item, index) => {
                itemsHtml += `
                    <tr class="h-10 text-sm">
                        <td class="border border-gray-300 px-3 text-center w-10">${index + 1}</td>
                        <td class="border border-gray-300 px-3 font-semibold">${item.name} <span class="text-xs text-gray-500">(${item.code})</span></td>
                        <td class="border border-gray-300 px-3">${item.description}</td>
                        <td class="border border-gray-300 px-3 text-center w-20">${item.qty.toLocaleString()}</td>
                        <td class="border border-gray-300 px-3 text-center w-20">‡∏ä‡∏∏‡∏î</td>
                        <td class="border border-gray-300 px-3 text-right w-24">${item.unitPrice.toLocaleString('th-TH', {minimumFractionDigits: 2})}</td>
                        <td class="border border-gray-300 px-3 text-right w-28 font-bold">${item.total.toLocaleString('th-TH', {minimumFractionDigits: 2})}</td>
                    </tr>
                `;
            });

            const subtotalFormatted = data.subtotal.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            let vat = 0;
            let vatHtml = '';
            if (data.vatOption === 'include') {
                vat = data.subtotal * 0.07;
                vatHtml = `<div class="flex justify-between p-2 border-b border-gray-800"><span class="text-sm">‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° 7% (VAT)</span><span class="text-sm">${vat.toLocaleString('th-TH', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span></div>`;
            }

            const netTotal = data.subtotal + vat;

            return `
                <div class="space-y-6 text-gray-800" style="font-family: 'Sarabun', sans-serif;">
                    <header class="text-center border-b-2 border-gray-800 pb-4">
                        <h1 class="text-3xl font-bold mb-1">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (QUOTATION)</h1>
                        <p class="text-xl font-semibold">${data.sellerName}</p>
                        <p class="text-sm whitespace-pre-wrap">${data.sellerInfo}</p>
                    </header>
                    <div class="flex justify-between text-sm">
                        <div class="w-1/2 pr-4 border border-gray-300 p-2 rounded-lg">
                            <p class="font-bold">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${data.customerName}</p>
                            <p>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${data.customerAddress}</p>
                        </div>
                        <div class="w-1/3 pl-4">
                            <p><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</strong> QUO-${new Date().getFullYear()}${new Date().getMonth()+1}${new Date().getDate()}</p>
                            <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${formattedDate}</p>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead><tr class="bg-gray-100 text-sm font-bold h-12"><td class="border border-gray-300 px-3 text-center">‡∏•‡∏≥‡∏î‡∏±‡∏ö</td><td class="border border-gray-300 px-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td><td class="border border-gray-300 px-3">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</td><td class="border border-gray-300 px-3 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</td><td class="border border-gray-300 px-3 text-center">‡∏´‡∏ô‡πà‡∏ß‡∏¢</td><td class="border border-gray-300 px-3 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</td><td class="border border-gray-300 px-3 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</td></tr></thead>
                            <tbody>${itemsHtml}${'<tr><td class="border border-gray-300 h-10"></td><td class="border border-gray-300"></td><td class="border border-gray-300"></td><td class="border border-gray-300"></td><td class="border border-gray-300"></td><td class="border border-gray-300"></td><td class="border border-gray-300"></td></tr>'.repeat(Math.max(0, 5 - validItems.length))}</tbody>
                        </table>
                    </div>
                    <div class="flex justify-between items-start">
                        <div class="w-3/5 pr-4 space-y-3">
                            <div class="border border-gray-400 p-3 rounded-lg"><p class="font-bold text-lg text-indigo-700 mb-2">‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</p><p class="text-sm">${data.paymentDetail}</p></div>
                            <div class="border border-gray-400 p-3 rounded-lg bg-gray-50"><p class="font-bold">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</p><p class="text-sm">${data.bankName} - ${data.accountNumber} (${data.accountName})</p></div>
                        </div>
                        <div class="w-2/5 border border-gray-800">
                            <div class="flex justify-between p-2 border-b border-gray-800"><span class="text-sm">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span><span class="text-sm">${subtotalFormatted}</span></div>
                            ${vatHtml}
                            <div class="flex justify-between p-2 bg-gray-200"><span class="text-lg font-bold">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span><span class="text-lg font-bold text-red-600">${netTotal.toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</span></div>
                        </div>
                    </div>
                    <div class="flex justify-between pt-10 text-sm">
                        <div class="w-5/12 text-center border-t border-gray-400 pt-2"><p>‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</p><p>(_________________________)</p></div>
                        <div class="w-5/12 text-center border-t border-gray-400 pt-2"><p>‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p><p>(_________________________)</p></div>
                    </div>
                </div>
            `;
        }

        function generateQuotation() {
            const data = getQuotationFormData();
            // Check for items with price > 0
            if(data.items.filter(i => i.qty > 0 && i.unitPrice > 0).length === 0) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô'); return; }
            document.getElementById('quotation-output').innerHTML = createQuotationHtml(data);
            document.getElementById('quotationModal').style.display = 'flex';
            document.getElementById('quotationCopyMessage').classList.add('hidden');
        }

        // --- Receipt Logic ---
        function addItemRowReceipt(description = '', quantity = 1, price = 0) {
            receiptItemCounter++;
            const tbody = document.getElementById('receiptItemTableBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-3 py-2 text-center text-gray-500">${receiptItemCounter}</td>
                <td class="px-6 py-2"><input type="text" value="${description}" class="w-full item-description p-1 border rounded"></td>
                <td class="px-6 py-2"><input type="number" value="${quantity}" min="1" class="w-full item-quantity p-1 border rounded text-right"></td>
                <td class="px-6 py-2"><input type="number" value="${price}" min="0" step="0.01" class="w-full item-price p-1 border rounded text-right"></td>
                <td class="px-6 py-2 text-right"><span class="item-total font-semibold text-gray-700">0.00</span></td>
                <td class="px-1 py-2 text-center no-print"><button type="button" class="remove-item-btn text-red-500 p-1">‡∏•‡∏ö</button></td>
            `;
            const update = () => calculateReceiptTotals();
            row.querySelector('.item-quantity').addEventListener('input', update);
            row.querySelector('.item-price').addEventListener('input', update);
            row.querySelector('.remove-item-btn').addEventListener('click', () => { row.remove(); reindexReceiptRows(); update(); });
            tbody.appendChild(row);
            update();
        }

        function reindexReceiptRows() {
            receiptItemCounter = 0;
            document.querySelectorAll('#receiptItemTableBody tr').forEach((row, i) => {
                receiptItemCounter = i + 1;
                row.querySelector('td:first-child').textContent = receiptItemCounter;
            });
        }

        function calculateReceiptTotals() {
            let subtotal = 0;
            const vatOption = document.querySelector('input[name="receiptVatOption"]:checked').value;
            document.querySelectorAll('#receiptItemTableBody tr').forEach(row => {
                const q = parseFloat(row.querySelector('.item-quantity').value) || 0;
                const p = parseFloat(row.querySelector('.item-price').value) || 0;
                const total = q * p;
                row.querySelector('.item-total').textContent = total.toLocaleString('th-TH', {minimumFractionDigits: 2});
                subtotal += total;
            });
            const vat = vatOption === 'include' ? subtotal * 0.07 : 0;
            return { subtotal, vat, grandTotal: subtotal + vat, vatOption };
        }

        function populateReceiptFromQuotation() {
            const qData = getQuotationFormData();
            // Filter valid items for receipt as well
            const validItems = qData.items.filter(i => i.qty > 0 && i.unitPrice > 0);
            
            if(validItems.length === 0) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤'); return; }
            
            document.getElementById('receiptItemTableBody').innerHTML = '';
            receiptItemCounter = 0;
            validItems.forEach(item => addItemRowReceipt(item.description, 1, item.total));
            
            if (qData.vatOption) {
                document.getElementsByName('receiptVatOption').forEach(r => r.checked = (r.value === qData.vatOption));
            }
            syncCustomerInfoToReceipt();
            calculateReceiptTotals();
            showToast('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        }

        function createReceiptHtml(data) {
            const totals = calculateReceiptTotals();
            let rowsHtml = '';
            document.querySelectorAll('#receiptItemTableBody tr').forEach((row, i) => {
                const d = row.querySelector('.item-description').value;
                const q = row.querySelector('.item-quantity').value;
                const p = parseFloat(row.querySelector('.item-price').value).toLocaleString('th-TH', {minimumFractionDigits: 2});
                const t = row.querySelector('.item-total').textContent;
                rowsHtml += `<tr class="h-8 text-sm"><td class="border px-3 text-center">${i+1}</td><td class="border px-3">${d}</td><td class="border px-3 text-right">${q}</td><td class="border px-3 text-right">${p}</td><td class="border px-3 text-right font-bold">${t}</td></tr>`;
            });

            let vatRow = totals.vatOption === 'include' ? `<div class="flex justify-between p-2 border-b border-gray-800"><span class="text-sm">VAT 7%</span><span class="text-sm">${totals.vat.toLocaleString('th-TH', {minimumFractionDigits: 2})}</span></div>` : '';

            return `
                <div class="space-y-6 text-gray-800" style="font-family: 'Sarabun', sans-serif;">
                    <header class="text-center border-b-2 border-gray-800 pb-4"><h1 class="text-3xl font-bold">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h1><p class="text-xl">${data.sellerName}</p><p class="text-sm">${data.sellerInfo}</p><p class="text-sm">TAX ID: ${data.sellerTaxId}</p></header>
                    <div class="flex justify-between text-sm"><div class="w-1/2 border p-2 rounded"><p>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${data.rCustomerName}</p><p>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà: ${data.rCustomerAddress}</p><p>TAX ID: ${data.rCustomerTaxId}</p></div><div class="w-1/3 pl-4"><p>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${data.receiptNo}</p><p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date(data.receiptDate).toLocaleDateString('th-TH')}</p><p>‡∏ä‡∏≥‡∏£‡∏∞‡πÇ‡∏î‡∏¢: ${data.paymentMethod}</p></div></div>
                    <table class="w-full border-collapse"><thead><tr class="bg-gray-100 text-sm font-bold h-10"><td class="border px-3 text-center">#</td><td class="border px-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td><td class="border px-3 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</td><td class="border px-3 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤</td><td class="border px-3 text-right">‡∏£‡∏ß‡∏°</td></tr></thead><tbody>${rowsHtml}${'<tr><td class="border h-8"></td><td class="border"></td><td class="border"></td><td class="border"></td><td class="border"></td></tr>'.repeat(Math.max(0, 5 - receiptItemCounter))}</tbody></table>
                    <div class="flex justify-between pt-4"><div class="w-3/5 border p-2 rounded text-sm">** ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß **</div><div class="w-2/5 border border-gray-800"><div class="flex justify-between p-2 border-b"><span class="text-sm">‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô</span><span>${totals.subtotal.toLocaleString('th-TH', {minimumFractionDigits: 2})}</span></div>${vatRow}<div class="flex justify-between p-2 bg-gray-200"><span class="text-lg font-bold">‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span><span class="text-lg font-bold text-blue-600">${totals.grandTotal.toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó</span></div></div></div>
                    <div class="flex justify-between pt-10 text-sm"><div class="w-5/12 text-center border-t pt-2">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div><div class="w-5/12 text-center border-t pt-2">‡∏ú‡∏π‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</div></div>
                </div>
            `;
        }

        function generateReceipt() {
            const data = {
                sellerName: document.getElementById('sellerName').value,
                sellerInfo: document.getElementById('sellerInfo').value,
                sellerTaxId: document.getElementById('sellerTaxId').value,
                rCustomerName: document.getElementById('rCustomerName').value,
                rCustomerAddress: document.getElementById('rCustomerAddress').value,
                rCustomerTaxId: document.getElementById('rCustomerTaxId').value,
                receiptNo: document.getElementById('receiptNo').value,
                receiptDate: document.getElementById('receiptDate').value,
                paymentMethod: document.getElementById('paymentMethod').value,
            };
            document.getElementById('receipt-output').innerHTML = createReceiptHtml(data);
            document.getElementById('receiptModal').style.display = 'flex';
        }

        // --- Export Tools ---
        function downloadPDF(type) {
            const id = type === 'quotation' ? 'quotation-output' : 'receipt-output';
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'pt', 'a4');
            html2canvas(document.getElementById(id), { scale: 2, scrollY: -window.scrollY }).then(canvas => {
                const w = pdf.internal.pageSize.getWidth();
                const h = (canvas.height * w) / canvas.width;
                pdf.addImage(canvas.toDataURL('image/jpeg', 1.0), 'JPEG', 0, 0, w, h);
                pdf.save(`${type}_${new Date().toISOString().slice(0,10)}.pdf`);
            });
        }

        function captureScreen(type) {
            const id = type === 'quotation' ? 'quotation-output' : 'receipt-output';
            html2canvas(document.getElementById(id), { scale: 2, scrollY: -window.scrollY }).then(c => {
                c.toBlob(b => navigator.clipboard.write([new ClipboardItem({"image/png": b})]).then(() => {
                    const msg = document.getElementById(type+'CopyMessage');
                    msg.classList.remove('hidden'); setTimeout(()=>msg.classList.add('hidden'), 3000);
                }));
            });
        }

        // --- AI Logic ---
        const apiKey = ""; 
        async function generatePaymentDetails() {
            const btn = document.getElementById('generatePaymentBtn');
            const box = document.getElementById('paymentDetail');
            const oldHtml = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = '<span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...</span>';
            box.placeholder = 'AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...';
            
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ${document.getElementById('customerName').value || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'} (‡∏°‡∏±‡∏î‡∏à‡∏≥ 50%)` }] }]
                    })
                });
                const data = await res.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if(text) box.value = text.trim();
            } catch(e) { console.error(e); } 
            finally { btn.disabled = false; btn.innerHTML = oldHtml; box.placeholder = '‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç...'; }
        }
    </script>
</body>
</html>
