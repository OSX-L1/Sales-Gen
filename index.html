<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>เครื่องมือจัดการเอกสารขาย (ใบเสนอราคา & ใบเสร็จ) + ระบบบันทึก</title>
    
    <!-- โหลด Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- โหลด Google Font Sarabun TH -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <!-- โหลด Library สำหรับ PDF/Capture -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- โหลด Firebase SDK (ใช้เวอร์ชัน compat เพื่อความง่ายในการใช้งานในไฟล์เดียว) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        /* กำหนดสไตล์สำหรับเอกสารที่จะพิมพ์ */
        .document-container {
            width: 21cm; /* A4 width */
            min-height: 29.7cm; /* A4 height */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background: white;
            margin: 20px auto;
        }
        /* ซ่อนรายการเอกสารเมื่อพิมพ์ */
        @media print {
            .sidebar-controls, .controls-container, .document-footer, .action-buttons {
                display: none !important;
            }
            .document-container {
                margin: 0;
                box-shadow: none;
                width: 100%;
                min-height: 100vh;
            }
        }
        /* เพื่อซ่อนปุ่มหมุนใน input type=number */
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }
        /* สไตล์สำหรับฟอร์มในหน้าหลัก */
        .item-row input, .item-row select, .item-row textarea {
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.875rem; /* text-sm */
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col lg:flex-row min-h-screen">
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="text-white text-lg flex flex-col items-center">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="mt-2">กำลังโหลด...</span>
        </div>
    </div>

    <!-- ส่วน Sidebar/Controls สำหรับ Mobile/Desktop -->
    <div class="sidebar-controls bg-white p-4 w-full lg:w-72 lg:min-h-screen border-r border-gray-200 shadow-lg flex flex-col">
        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">เอกสารที่บันทึกไว้</h2>
        <div id="userIdDisplay" class="text-sm text-gray-600 mb-4 p-2 bg-gray-100 rounded-lg">
            User ID: <span id="currentUserId" class="font-mono break-all text-blue-600">กำลังโหลด...</span>
        </div>

        <!-- รายการเอกสาร -->
        <ul id="documentList" class="space-y-2 flex-grow overflow-y-auto pb-4">
            <li class="text-gray-500 italic">ไม่มีเอกสาร</li>
        </ul>

        <!-- ปุ่มควบคุมหลัก -->
        <div class="controls-container mt-4 pt-4 border-t border-gray-200 space-y-3">
            <button id="newDocumentBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                <i class="fas fa-plus mr-2"></i> สร้างเอกสารใหม่
            </button>
            <button id="saveDocumentBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                <i class="fas fa-save mr-2"></i> บันทึกเอกสาร
            </button>
            <button id="previewDocumentBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                <i class="fas fa-eye mr-2"></i> แสดงตัวอย่างใบเสนอราคา
            </button>
            <button id="captureDocumentBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                <i class="fas fa-camera mr-2"></i> แคปหน้าจอ (PNG)
            </button>
            <button id="printDocumentBtn" class="w-full bg-red-500 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                <i class="fas fa-print mr-2"></i> พิมพ์ / สร้าง PDF
            </button>
            <div id="messageBox" class="p-3 bg-indigo-100 text-indigo-800 text-sm rounded-lg hidden transition duration-300"></div>
        </div>
    </div>

    <!-- พื้นที่ทำงานหลักและเอกสาร -->
    <main class="flex-grow p-4 lg:p-8 overflow-y-auto">
        
        <!-- Document Container (A4 Mockup) -->
        <div id="documentToCapture" class="document-container p-6 md:p-10 lg:p-12 shadow-xl">

            <!-- Header and Type Selector -->
            <div class="flex flex-col sm:flex-row justify-between items-start border-b-4 border-indigo-600 pb-4 mb-6">
                <div class="flex flex-col">
                    <input type="text" id="companyName" value="ชื่อบริษัท/ร้านค้าของคุณ" class="text-2xl sm:text-3xl font-bold mb-1 p-1" placeholder="ชื่อบริษัท">
                    <textarea id="companyAddress" class="text-sm text-gray-600 w-full p-1 h-12 resize-none" placeholder="ที่อยู่และเบอร์โทรศัพท์"></textarea>
                </div>
                <div class="mt-4 sm:mt-0 flex-shrink-0">
                    <select id="documentType" class="text-xl font-bold text-center p-2 rounded-lg border-2 border-gray-300 bg-gray-100">
                        <option value="ใบเสนอราคา">ใบเสนอราคา</option>
                        <option value="ใบเสร็จรับเงิน">ใบเสร็จรับเงิน</option>
                    </select>
                </div>
            </div>

            <!-- Customer and Document Info -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-sm">
                <div class="col-span-1 md:col-span-2 space-y-2 p-3 border rounded-lg bg-gray-50">
                    <div class="flex items-center">
                        <label class="w-24 font-semibold">ลูกค้า:</label>
                        <input type="text" id="customerName" class="flex-grow p-1" placeholder="ชื่อลูกค้า/บริษัท">
                    </div>
                    <div class="flex items-start">
                        <label class="w-24 font-semibold">ที่อยู่:</label>
                        <textarea id="customerAddress" class="flex-grow p-1 h-10 resize-none" placeholder="ที่อยู่ลูกค้า"></textarea>
                    </div>
                    <div class="flex items-center">
                        <label class="w-24 font-semibold">ติดต่อ:</label>
                        <input type="text" id="customerContact" class="flex-grow p-1" placeholder="เบอร์โทร/อีเมล">
                    </div>
                </div>
                <div class="col-span-1 space-y-2 p-3 border rounded-lg bg-gray-50">
                    <div class="flex items-center">
                        <label class="w-24 font-semibold">เลขที่:</label>
                        <input type="text" id="documentNumber" class="flex-grow p-1" placeholder="QUO-001/2567">
                    </div>
                    <div class="flex items-center">
                        <label class="w-24 font-semibold">วันที่:</label>
                        <input type="date" id="documentDate" class="flex-grow p-1">
                    </div>
                    <div class="flex items-center">
                        <label class="w-24 font-semibold">กำหนดชำระ:</label>
                        <input type="date" id="dueDate" class="flex-grow p-1">
                    </div>
                </div>
            </div>

            <!-- Items Table Header (Updated to include Category/Dimensions) -->
            <!-- ใช้ text-xs เพื่อให้ตารางแคบลงใน PDF/Preview -->
            <div class="flex text-xs md:text-sm font-bold bg-indigo-600 text-white rounded-t-lg p-2 mt-8">
                <span class="w-8 text-center">#</span>
                <span class="w-28 text-center">หมวดหมู่</span>
                <span class="w-16 text-center">รหัส</span>
                <span class="flex-grow ml-2">รายละเอียด</span>
                <span class="w-12 text-center">กว้าง</span>
                <span class="w-12 text-center">สูง</span>
                <span class="w-12 text-center">จำนวน</span>
                <span class="w-16 text-right">ราคา/หน่วย</span>
                <span class="w-20 text-right">รวม (บาท)</span>
                <span class="w-8 text-center">ลบ</span>
            </div>

            <!-- Items Table Body -->
            <div id="itemsContainer" class="border border-gray-300 border-t-0 text-sm">
                <!-- Item Rows will be inserted here -->
            </div>
            
            <!-- Add Item Button -->
            <button id="addItemBtn" class="w-full text-indigo-600 hover:text-indigo-800 border-b border-l border-r border-gray-300 py-2 transition duration-150 text-sm font-semibold">
                + เพิ่มรายการ
            </button>
            
            <!-- Summary and Totals -->
            <div class="flex flex-wrap mt-6">
                <!-- Payment Details & Notes -->
                <div class="w-full lg:w-2/3 pr-0 lg:pr-4 mb-4 lg:mb-0">
                    <h3 class="text-md font-bold mb-2">เงื่อนไขการชำระเงินและหมายเหตุ</h3>
                    <div class="relative mb-2">
                         <textarea id="paymentDetail" rows="4" class="w-full p-2 border rounded-lg text-sm bg-white resize-none" placeholder="เช่น ชำระ 50% มัดจำ ส่วนที่เหลือชำระวันส่งมอบ"></textarea>
                        <button id="generatePaymentBtn" class="absolute top-1 right-1 bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-2 rounded-full transition duration-150 shadow-md">
                            AI ช่วยสร้าง
                        </button>
                    </div>
                   
                    <textarea id="documentNote" rows="2" class="w-full p-2 border rounded-lg text-sm bg-white resize-none" placeholder="หมายเหตุเพิ่มเติม (ถ้ามี)"></textarea>
                </div>
                
                <!-- Totals -->
                <div class="w-full lg:w-1/3 bg-gray-50 p-4 border rounded-lg shadow-inner">
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">รวมราคาสินค้า (ไม่รวมภาษี):</span>
                        <span id="subTotal" class="font-semibold">0.00</span>
                    </div>
                    <div class="flex justify-between mb-2 items-center">
                        <label class="font-semibold flex items-center">ภาษีมูลค่าเพิ่ม 
                            <input type="number" id="taxRate" value="7" min="0" max="100" class="w-12 text-right ml-2 border p-0.5 rounded text-sm"> %:
                        </label>
                        <span id="taxAmount" class="font-semibold text-red-600">0.00</span>
                    </div>
                    <div class="flex justify-between border-t border-gray-300 pt-3 mt-3">
                        <span class="text-xl font-bold text-indigo-600">ยอดรวมสุทธิ:</span>
                        <span id="grandTotal" class="text-xl font-bold text-indigo-600">0.00</span>
                    </div>
                </div>
            </div>

            <!-- Footer (Signatures) -->
            <div class="document-footer grid grid-cols-2 gap-8 mt-16 text-sm">
                <div class="text-center">
                    <div class="mt-12 border-b border-gray-400 w-3/4 mx-auto pb-1"></div>
                    <p class="mt-2">ผู้รับเอกสาร (ลงชื่อ)</p>
                    <p>(................................................)</p>
                </div>
                <div class="text-center">
                    <div class="mt-12 border-b border-gray-400 w-3/4 mx-auto pb-1"></div>
                    <p class="mt-2">ผู้ออกเอกสาร (ลงชื่อ)</p>
                    <p>(................................................)</p>
                </div>
            </div>

        </div>
    </main>

    <!-- Modal: Preview/Delete Confirmation -->
    
    <!-- Delete Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-80">
            <h3 class="text-lg font-bold mb-4">ยืนยันการลบ</h3>
            <p>คุณต้องการลบเอกสาร "<span id="docToDeleteName" class="font-semibold text-red-600"></span>" ใช่หรือไม่? การดำเนินการนี้ไม่สามารถยกเลิกได้</p>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="cancelDeleteBtn" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-lg text-sm">ยกเลิก</button>
                <button id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">ลบ</button>
            </div>
        </div>
    </div>
    
    <!-- Preview Modal -->
    <div id="previewModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden">
        <div class="bg-white p-2 md:p-4 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center border-b pb-2 mb-2">
                 <h3 class="text-lg font-bold">ตัวอย่างใบเสนอราคา</h3>
                 <button id="closePreviewBtn" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
            </div>
            <div id="previewContent" class="flex-grow overflow-y-auto p-4 border rounded-lg bg-gray-50">
                <!-- Document content will be cloned here -->
            </div>
            <div class="mt-4 flex justify-end">
                <button id="downloadPreviewPdfBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm shadow-md">ดาวน์โหลดเป็น PDF</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- Global Variables (Provided by Canvas) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let currentDocumentId = null;
        let currentDocumentData = {};
        
        const CATEGORIES = [
            { value: 'ฉาก PVC', label: 'ฉาก PVC' },
            { value: 'ม่านม้วน', label: 'ม่านม้วน' },
            { value: 'มู่ลี่ไม้', label: 'มู่ลี่ไม้' },
            { value: 'มู่ลี่อลูมิเนียม', label: 'มู่ลี่อลูมิเนียม' }
        ];

        const documentElements = {
            docType: document.getElementById('documentType'),
            companyName: document.getElementById('companyName'),
            companyAddress: document.getElementById('companyAddress'),
            customerName: document.getElementById('customerName'),
            customerAddress: document.getElementById('customerAddress'),
            customerContact: document.getElementById('customerContact'),
            docNumber: document.getElementById('documentNumber'),
            docDate: document.getElementById('documentDate'),
            dueDate: document.getElementById('dueDate'),
            paymentDetail: document.getElementById('paymentDetail'),
            documentNote: document.getElementById('documentNote'),
            taxRate: document.getElementById('taxRate'),
            itemsContainer: document.getElementById('itemsContainer'),
            subTotal: document.getElementById('subTotal'),
            taxAmount: document.getElementById('taxAmount'),
            grandTotal: document.getElementById('grandTotal'),
        };

        // --- Utility Functions ---

        /** แสดงข้อความสถานะชั่วคราว */
        function showMessage(text, isError = false) {
            const msg = document.getElementById('messageBox');
            // ตรวจสอบว่ามี element อยู่จริงหรือไม่ ก่อนดำเนินการ
            if (!msg) {
                console.warn('Message box element not found.');
                return;
            }
            msg.textContent = text;
            msg.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-indigo-100', 'text-indigo-800');
            msg.classList.add(isError ? 'bg-red-100' : 'bg-indigo-100', isError ? 'text-red-800' : 'text-indigo-800');
            setTimeout(() => {
                msg.classList.add('hidden');
            }, 3000);
        }

        /** ดึงข้อมูลจาก UI Elements มาเก็บใน Object */
        function getDocumentDataFromUI() {
            const items = Array.from(documentElements.itemsContainer.querySelectorAll('.item-row')).map(row => {
                // ต้องมี try-catch ในการแปลงค่า เพราะค่าใน input อาจเป็น undefined
                try {
                    return {
                        category: row.querySelector('select[name="category"]').value, 
                        productCode: row.querySelector('input[name="productCode"]').value,
                        description: row.querySelector('textarea[name="description"]').value,
                        // ใช้ parseFloat() เพื่อแปลงค่าจาก input string ให้เป็นตัวเลข
                        width: parseFloat(row.querySelector('input[name="width"]').value) || 0,
                        height: parseFloat(row.querySelector('input[name="height"]').value) || 0,
                        quantity: parseFloat(row.querySelector('input[name="quantity"]').value) || 0,
                        unitPrice: parseFloat(row.querySelector('input[name="unitPrice"]').value) || 0,
                        id: row.dataset.id
                    };
                } catch (e) {
                    console.error("Error reading item row data:", e);
                    return null;
                }
            }).filter(item => item !== null);

            const data = {
                documentType: documentElements.docType?.value || 'ใบเสนอราคา',
                companyName: documentElements.companyName?.value || 'ชื่อบริษัท/ร้านค้าของคุณ',
                companyAddress: documentElements.companyAddress?.value || '',
                customerName: documentElements.customerName?.value || '',
                customerAddress: documentElements.customerAddress?.value || '',
                customerContact: documentElements.customerContact?.value || '',
                documentNumber: documentElements.docNumber?.value || '',
                documentDate: documentElements.docDate?.value || '',
                dueDate: documentElements.dueDate?.value || '',
                paymentDetail: documentElements.paymentDetail?.value || '',
                documentNote: documentElements.documentNote?.value || '',
                taxRate: parseFloat(documentElements.taxRate?.value) || 0,
                items: items,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            const totals = calculateTotals(data.items, data.taxRate);
            return { ...data, ...totals };
        }

        /** คำนวณยอดรวมทั้งหมด */
        function calculateTotals(items, taxRate) {
            const subTotal = items.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
            
            const rate = (taxRate || 0) / 100;
            const taxAmount = subTotal * rate;
            const grandTotal = subTotal + taxAmount;
            
            return {
                subTotal: parseFloat(subTotal.toFixed(2)),
                taxAmount: parseFloat(taxAmount.toFixed(2)),
                grandTotal: parseFloat(grandTotal.toFixed(2))
            };
        }

        /** อัปเดต UI ด้วยค่า Total ที่คำนวณใหม่ */
        function updateTotalsUI() {
             try {
                const data = getDocumentDataFromUI();
                
                documentElements.subTotal.textContent = data.subTotal.toLocaleString('th-TH', { minimumFractionDigits: 2 });
                documentElements.taxAmount.textContent = data.taxAmount.toLocaleString('th-TH', { minimumFractionDigits: 2 });
                documentElements.grandTotal.textContent = data.grandTotal.toLocaleString('th-TH', { minimumFractionDigits: 2 });
                
                // อัปเดตผลรวมในแต่ละแถว
                documentElements.itemsContainer.querySelectorAll('.item-row').forEach(row => {
                    const quantity = parseFloat(row.querySelector('input[name="quantity"]').value) || 0;
                    const unitPrice = parseFloat(row.querySelector('input[name="unitPrice"]').value) || 0;
                    const total = (quantity * unitPrice).toFixed(2);
                    row.querySelector('.item-total').textContent = parseFloat(total).toLocaleString('th-TH', { minimumFractionDigits: 2 });
                });
                
                document.querySelector('title').textContent = `${data.documentType} | เครื่องมือจัดการเอกสารขาย`;
            } catch (e) {
                console.error("Error updating totals UI:", e);
                // ไม่ต้องแสดง error box เนื่องจากอาจเป็น input error เล็กๆ
            }
        }

        /** สร้างแถวรายการสินค้าใน UI */
        function createItemRow(item = { 
            category: 'ฉาก PVC', 
            productCode: '', 
            description: '', 
            width: 0, 
            height: 0, 
            quantity: 1, 
            unitPrice: 0, 
            id: crypto.randomUUID() 
        }) {
            const row = document.createElement('div');
            row.className = 'item-row flex items-center border-b border-gray-200 text-sm py-2';
            row.dataset.id = item.id;
            
            const total = (item.quantity * item.unitPrice).toFixed(2);
            
            // สร้าง options สำหรับหมวดหมู่
            const categoryOptions = CATEGORIES.map(cat => 
                `<option value="${cat.value}" ${item.category === cat.value ? 'selected' : ''}>${cat.label}</option>`
            ).join('');

            row.innerHTML = `
                <span class="w-8 text-center item-index font-mono text-gray-500"></span>
                <select name="category" class="w-28 border rounded mr-1 flex-shrink-0">${categoryOptions}</select>
                <input type="text" name="productCode" value="${item.productCode}" class="w-16 border rounded mr-1 flex-shrink-0" placeholder="รหัส">
                <textarea name="description" class="flex-grow p-1 ml-1 resize-none h-10 border rounded" placeholder="รายละเอียดอื่นๆ">${item.description}</textarea>
                <input type="number" name="width" value="${item.width}" min="0" step="0.01" class="w-12 text-center border rounded mx-1 flex-shrink-0" placeholder="ก">
                <input type="number" name="height" value="${item.height}" min="0" step="0.01" class="w-12 text-center border rounded mx-1 flex-shrink-0" placeholder="ส">
                <input type="number" name="quantity" value="${item.quantity}" min="0" class="w-12 text-center border rounded mx-1 flex-shrink-0" placeholder="จำ">
                <input type="number" name="unitPrice" value="${item.unitPrice}" min="0" step="0.01" class="w-16 text-right border rounded mx-1 flex-shrink-0" placeholder="ราคา">
                <span class="w-20 text-right item-total font-semibold pr-1 flex-shrink-0">${parseFloat(total).toLocaleString('th-TH', { minimumFractionDigits: 2 })}</span>
                <button type="button" class="w-8 text-center text-red-500 hover:text-red-700 delete-item-btn flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                    </svg>
                </button>
            `;

            // เพิ่ม Event Listeners สำหรับการคำนวณ
            const inputs = row.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', updateTotalsUI);
            });

            // Event Listener สำหรับปุ่มลบ
            row.querySelector('.delete-item-btn').addEventListener('click', () => {
                row.remove();
                renumberItems();
                updateTotalsUI();
            });

            return row;
        }

        /** จัดลำดับเลขรายการใหม่ */
        function renumberItems() {
            documentElements.itemsContainer.querySelectorAll('.item-row').forEach((row, index) => {
                row.querySelector('.item-index').textContent = index + 1;
            });
        }

        /** โหลดข้อมูลเอกสารลงใน UI */
        function renderDocumentData(data) {
            currentDocumentData = data;
            
            documentElements.docType.value = data.documentType || 'ใบเสนอราคา';
            documentElements.companyName.value = data.companyName || 'ชื่อบริษัท/ร้านค้าของคุณ';
            documentElements.companyAddress.value = data.companyAddress || '';
            documentElements.customerName.value = data.customerName || '';
            documentElements.customerAddress.value = data.customerAddress || '';
            documentElements.customerContact.value = data.customerContact || '';
            documentElements.docNumber.value = data.documentNumber || '';
            documentElements.docDate.value = data.documentDate || new Date().toISOString().substring(0, 10);
            documentElements.dueDate.value = data.dueDate || '';
            documentElements.paymentDetail.value = data.paymentDetail || '';
            documentElements.documentNote.value = data.documentNote || '';
            documentElements.taxRate.value = data.taxRate || 7;
            
            // Render Items
            documentElements.itemsContainer.innerHTML = '';
            // ตรวจสอบว่า data.items มีอยู่และเป็น Array ที่มีข้อมูลหรือไม่
            const itemsToRender = (Array.isArray(data.items) && data.items.length > 0) 
                                ? data.items 
                                : [{ category: 'ฉาก PVC', productCode: '', description: '', width: 0, height: 0, quantity: 1, unitPrice: 0, id: crypto.randomUUID() }];
                                
            itemsToRender.forEach(item => {
                documentElements.itemsContainer.appendChild(createItemRow(item));
            });

            renumberItems();
            updateTotalsUI();
        }

        /** เคลียร์ฟอร์มสำหรับเอกสารใหม่ */
        function createNewDocument() {
            currentDocumentId = null;
            renderDocumentData({ 
                documentType: 'ใบเสนอราคา',
                documentDate: new Date().toISOString().substring(0, 10),
                companyName: 'ชื่อบริษัท/ร้านค้าของคุณ'
            });
            document.querySelectorAll('#documentList button').forEach(btn => btn.closest('li').classList.remove('bg-indigo-200', 'shadow-inner'));
            document.getElementById('saveDocumentBtn').textContent = 'บันทึกเอกสาร';
            showMessage('สร้างเอกสารใหม่เรียบร้อยแล้ว');
        }

        // --- Firestore Setup and Data Handling ---

        /** กำหนด Path Collection สำหรับผู้ใช้ปัจจุบัน */
        const getCollectionRef = () => {
            if (!db || !userId) throw new Error("Firebase or User ID not initialized.");
            // Mandatory path: /artifacts/{appId}/users/{userId}/documents
            return db.collection(`artifacts/${appId}/users/${userId}/documents`);
        };

        /** Initialise Firebase และตรวจสอบสถานะผู้ใช้ */
        async function initFirebaseAndAuth() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            try {
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                auth = firebase.auth();
                
                // ใช้ Custom Token ถ้ามี, ไม่งั้นใช้ Anonymous Auth
                await new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged(async (user) => {
                        unsubscribe(); // หยุดฟังหลังจากการตรวจสอบครั้งแรก
                        if (user) {
                            userId = user.uid;
                        } else {
                            try {
                                if (initialAuthToken) {
                                    const userCredential = await auth.signInWithCustomToken(initialAuthToken);
                                    userId = userCredential.user.uid;
                                } else {
                                    const userCredential = await auth.signInAnonymously();
                                    userId = userCredential.user.uid;
                                }
                            } catch (e) {
                                console.error("Auth failed, falling back to anonymous sign-in.", e);
                                const userCredential = await auth.signInAnonymously();
                                userId = userCredential.user.uid;
                            }
                        }
                        
                        document.getElementById('currentUserId').textContent = userId;
                        // ตั้งค่าการทำงานของ Firestore Real-time Listener หลัง Auth
                        fetchAndRenderDocuments();
                        resolve();
                    }, reject);
                });
                
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessage('ข้อผิดพลาดในการเชื่อมต่อ Firebase. โปรดตรวจสอบ Console.', true);
            } finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }
        
        /** บันทึกหรืออัปเดตเอกสาร */
        async function saveDocument() {
            if (!userId) { showMessage('กำลังตรวจสอบสิทธิ์ผู้ใช้ กรุณาลองอีกครั้ง.', true); return; }
            const data = getDocumentDataFromUI();
            const saveBtn = document.getElementById('saveDocumentBtn');
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.innerHTML = `
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                กำลังบันทึก...
            `;

            try {
                if (currentDocumentId) {
                    // Update existing
                    await getCollectionRef().doc(currentDocumentId).update(data);
                    showMessage(`อัปเดตเอกสาร #${data.documentNumber || currentDocumentId} เรียบร้อยแล้ว`);
                } else {
                    // Add new document
                    const docRef = await getCollectionRef().add({ 
                        ...data, 
                        createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                    });
                    currentDocumentId = docRef.id;
                    showMessage(`บันทึกเอกสารใหม่ #${data.documentNumber || docRef.id} เรียบร้อยแล้ว`);
                }
            } catch (e) {
                console.error("Error saving document:", e);
                showMessage('ข้อผิดพลาดในการบันทึกเอกสาร: ' + e.message, true);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        /** ดึงข้อมูลเอกสารทั้งหมดแบบ Real-time และ Render ใน Sidebar */
        function fetchAndRenderDocuments() {
            if (!userId) return; // ไม่ทำงานจนกว่าจะมี userId
            
            const docList = document.getElementById('documentList');
            if (!docList) return; // Guard clause for robustness
            
            docList.innerHTML = '';
            
            // onSnapshot listener สำหรับการอัปเดตแบบ Real-time
            getCollectionRef().orderBy('updatedAt', 'desc').onSnapshot(snapshot => {
                docList.innerHTML = '';
                if (snapshot.empty) {
                    docList.innerHTML = '<li class="text-gray-500 italic">ยังไม่มีเอกสารที่บันทึกไว้</li>';
                    createNewDocument();
                    return;
                }

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const docId = doc.id;
                    const isActive = docId === currentDocumentId;

                    const listItem = document.createElement('li');
                    listItem.className = 'flex justify-between items-center p-2 rounded-lg transition duration-150 group ' + (isActive ? 'bg-indigo-200 shadow-inner' : 'hover:bg-gray-100');
                    listItem.innerHTML = `
                        <button class="flex-grow text-left text-sm font-medium truncate pr-2" data-doc-id="${docId}">
                            ${data.documentType || 'เอกสาร'}: ${data.documentNumber || docId.substring(0, 8)} - ${data.customerName || 'ลูกค้าทั่วไป'}
                        </button>
                        <button class="delete-doc-btn text-red-400 hover:text-red-600 p-1 rounded-full group-hover:opacity-100 ${isActive ? 'opacity-100' : 'opacity-0'}" data-doc-id="${docId}" data-doc-name="${data.documentNumber || docId.substring(0, 8)}">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    `;
                    docList.appendChild(listItem);

                    // Event Listener สำหรับโหลดเอกสาร
                    listItem.querySelector('button.flex-grow').addEventListener('click', () => loadDocument(docId));
                });
                
                // Event Listeners สำหรับปุ่มลบ (ต้องทำหลัง render)
                document.querySelectorAll('.delete-doc-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openDeleteModal(btn.dataset.docId, btn.dataset.docName);
                    });
                });

                // หากมีเอกสาร แต่ยังไม่มี ID ถูกเลือก ให้โหลดเอกสารแรก
                if (!currentDocumentId && snapshot.docs.length > 0) {
                    loadDocument(snapshot.docs[0].id);
                } else if (currentDocumentId) {
                    // หากเอกสารปัจจุบันถูกลบไปแล้ว ให้สร้างเอกสารใหม่
                    if (!snapshot.docs.find(doc => doc.id === currentDocumentId)) {
                        createNewDocument();
                    }
                }
                
                // อัปเดตสถานะปุ่มบันทึก
                const saveBtn = document.getElementById('saveDocumentBtn');
                if (saveBtn) {
                   saveBtn.textContent = currentDocumentId ? 'อัปเดตเอกสาร' : 'บันทึกเอกสาร';
                }
                

            }, err => {
                console.error("Firestore Snapshot Error:", err);
                showMessage('ข้อผิดพลาดในการดึงข้อมูลเอกสาร.', true);
            });
        }
        
        /** โหลดเอกสารจาก Firestore และ Render */
        async function loadDocument(docId) {
            try {
                const docSnap = await getCollectionRef().doc(docId).get();
                if (docSnap.exists) {
                    const data = docSnap.data();
                    currentDocumentId = docId;
                    renderDocumentData(data);
                    showMessage(`โหลดเอกสาร #${data.documentNumber || docId.substring(0, 8)} เรียบร้อยแล้ว`);
                    
                    // อัปเดต UI ใน Sidebar
                    document.querySelectorAll('#documentList button').forEach(btn => btn.closest('li').classList.remove('bg-indigo-200', 'shadow-inner'));
                    document.querySelector(`button[data-doc-id="${docId}"]`)?.closest('li').classList.add('bg-indigo-200', 'shadow-inner');
                    const saveBtn = document.getElementById('saveDocumentBtn');
                    if (saveBtn) saveBtn.textContent = 'อัปเดตเอกสาร';
                } else {
                    showMessage('ไม่พบเอกสารนี้.', true);
                    createNewDocument();
                }
            } catch (e) {
                console.error("Error loading document:", e);
                showMessage('ข้อผิดพลาดในการโหลดเอกสาร.', true);
            }
        }
        
        /** ลบเอกสาร */
        async function deleteDocument(docId) {
            try {
                await getCollectionRef().doc(docId).delete();
                showMessage(`ลบเอกสารเรียบร้อยแล้ว`);
                if (currentDocumentId === docId) {
                    currentDocumentId = null;
                }
            } catch (e) {
                console.error("Error deleting document:", e);
                showMessage('ข้อผิดพลาดในการลบเอกสาร.', true);
            }
        }

        // --- Modal Handlers ---
        
        // Delete Modal
        let docIdToDelete = null;

        function openDeleteModal(docId, docName) {
            docIdToDelete = docId;
            document.getElementById('docToDeleteName').textContent = docName;
            document.getElementById('deleteModal').classList.remove('hidden');
            document.getElementById('deleteModal').classList.add('flex');
        }

        function closeDeleteModal() {
            docIdToDelete = null;
            document.getElementById('deleteModal').classList.add('hidden');
            document.getElementById('deleteModal').classList.remove('flex');
        }

        document.getElementById('cancelDeleteBtn').addEventListener('click', closeDeleteModal);
        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (docIdToDelete) {
                await deleteDocument(docIdToDelete);
            }
            closeDeleteModal();
        });

        // Preview Modal
        function openPreviewModal() {
             try {
                const previewContent = document.getElementById('previewContent');
                const inputDocument = document.getElementById('documentToCapture');
                
                // 1. โคลนเนื้อหาทั้งหมดและดึงข้อมูลล่าสุด
                const data = getDocumentDataFromUI();
                const documentClone = inputDocument.cloneNode(true);
                
                // 2. ลบส่วนควบคุมที่ไม่ต้องการใน Preview
                documentClone.querySelector('.document-footer').style.marginTop = '4rem'; // ปรับระยะห่าง
                documentClone.querySelector('#addItemBtn').remove();
                
                // ตรวจสอบและลบปุ่ม AI ช่วยสร้าง ถ้ามี
                const aiBtn = documentClone.querySelector('#generatePaymentBtn');
                if (aiBtn) aiBtn.remove();
                
                // 3. ปรับปรุง Header ของตารางให้ตรงกับขนาด Preview/PDF
                const tableHeader = documentClone.querySelector('.flex.font-bold');
                if(tableHeader) {
                    tableHeader.classList.remove('md:text-sm');
                    tableHeader.classList.add('text-xs', 'py-1');
                    // ลบช่อง 'ลบ' ออกจาก Header ใน Preview
                    const deleteHeaderSpan = tableHeader.querySelector('.w-8.text-center');
                    if (deleteHeaderSpan) deleteHeaderSpan.remove();
                }

                // 4. วนลูปเพื่อแทนที่ Input/Select/Textarea ด้วยค่าจริง (Text/Span) และแก้ปัญหาข้อมูลไม่ตรง
                documentClone.querySelectorAll('.item-row').forEach((rowClone, index) => {
                    const rowData = data.items[index];
                    if (!rowData) { rowClone.remove(); return; } 

                    // ปรับปรุงขนาดแถวใน Preview/PDF
                    rowClone.classList.remove('py-2', 'text-sm');
                    rowClone.classList.add('py-1', 'text-xs');
                    
                    // ลบปุ่มลบออกจาก Row ใน Preview
                    const deleteBtn = rowClone.querySelector('.delete-item-btn');
                    if (deleteBtn) deleteBtn.remove();
                    
                    // ######################################################################
                    // แก้ปัญหาหมวดหมู่และข้อมูลไม่ตรง/ถูกบัง
                    // ######################################################################
                    const elementsToReplace = [
                        { name: 'category', value: rowData.category, width: 'w-28' }, // หมวดหมู่
                        { name: 'productCode', value: rowData.productCode, width: 'w-16' }, // รหัสสินค้า
                        { name: 'description', value: rowData.description, flex: true }, // รายละเอียด
                        { name: 'width', value: rowData.width ? rowData.width.toFixed(2) : '', width: 'w-12', align: 'center' }, // กว้าง
                        { name: 'height', value: rowData.height ? rowData.height.toFixed(2) : '', width: 'w-12', align: 'center' }, // สูง
                        { name: 'quantity', value: rowData.quantity, width: 'w-12', align: 'center' }, // จำนวน
                        { name: 'unitPrice', value: rowData.unitPrice.toLocaleString('th-TH', { minimumFractionDigits: 2 }), width: 'w-16', align: 'right' } // ราคา/หน่วย
                    ];

                    elementsToReplace.forEach(item => {
                        const el = rowClone.querySelector(`[name="${item.name}"]`);
                        if (el) {
                            const span = document.createElement('div');
                            span.textContent = item.value;
                            // คัดลอก class ที่ควบคุม Layout
                            const baseClass = item.flex ? 'flex-grow ml-1 mr-1' : `${item.width} mx-1 flex-shrink-0`; 
                            span.className = `p-0 ${baseClass} ${item.align ? `text-${item.align}` : ''} whitespace-nowrap overflow-hidden`;

                            el.parentNode.replaceChild(span, el);
                        }
                    });

                    // แทนที่ input/textarea นอกตารางด้วย span/div
                    rowClone.querySelectorAll('input, select, textarea').forEach(el => {
                        // สำหรับ item-total ให้ข้ามเพราะมันเป็น span อยู่แล้ว
                        if (el.classList.contains('item-total')) return;

                        const textContent = el.tagName === 'SELECT' ? el.options[el.selectedIndex].text : el.value;
                        const displayElement = document.createElement(el.tagName === 'TEXTAREA' ? 'div' : 'span');
                        displayElement.textContent = textContent;
                        
                        // คัดลอก class ที่จำเป็น (เช่น width, flex-grow) และลบ border/padding ของฟอร์ม
                        const className = el.className;
                        displayElement.className = className.replace('p-1', 'px-1').replace('border rounded', '').replace('resize-none', '').replace('w-full', 'w-full block');
                        
                        // การจัดการพิเศษสำหรับ input/select ที่มีค่าคงที่ (เช่น Company Name, Doc Type)
                        if (el.id === 'documentType' || el.id === 'companyName' || el.id === 'taxRate') {
                            displayElement.textContent = textContent;
                            displayElement.className = el.className.replace('p-2', 'px-2').replace('border-2', '').replace('bg-gray-100', '');
                        }
                        
                        el.parentNode.replaceChild(displayElement, el);
                    });
                });
                
                // แทนที่ input/textarea ในส่วนหัวและท้าย
                documentClone.querySelectorAll('.document-container input, .document-container select, .document-container textarea').forEach(el => {
                    const textContent = el.tagName === 'SELECT' ? el.options[el.selectedIndex].text : el.value;
                    const displayElement = document.createElement(el.tagName === 'TEXTAREA' ? 'div' : 'span');
                    displayElement.textContent = textContent;
                    
                    // คัดลอก class ที่จำเป็น (เช่น width, flex-grow) และลบ border/padding ของฟอร์ม
                    const className = el.className;
                    displayElement.className = className.replace('p-1', 'px-1').replace('p-2', 'px-2').replace('border rounded', '').replace('border-2', '').replace('bg-gray-100', '');
                    
                    // ปรับปรุงการแสดงผลของ input date
                    if (el.type === 'date' && textContent) {
                        const date = new Date(textContent + 'T00:00:00'); // แก้ปัญหา Timezone offset
                        displayElement.textContent = date.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
                    }
                    
                    el.parentNode.replaceChild(displayElement, el);
                });
                
                // 5. Clear existing preview and append clone
                previewContent.innerHTML = '';
                previewContent.appendChild(documentClone);
                documentClone.style.margin = '0';
                documentClone.style.boxShadow = 'none';
                documentClone.style.padding = '0'; // ลบ padding เดิม
                documentClone.querySelector('div:first-child').style.padding = '3rem'; // เพิ่ม padding กลับเข้าไปใน div แรก

                // 6. Show modal
                document.getElementById('previewModal').classList.remove('hidden');
                document.getElementById('previewModal').classList.add('flex');
            } catch (error) {
                console.error("Error opening preview modal:", error);
                showMessage('เกิดข้อผิดพลาดในการแสดงตัวอย่าง. โปรดดูใน Console.', true);
            }
        }

        function closePreviewModal() {
            document.getElementById('previewModal').classList.add('hidden');
            document.getElementById('previewModal').classList.remove('flex');
        }
        
        document.getElementById('previewDocumentBtn').addEventListener('click', openPreviewModal);
        document.getElementById('closePreviewBtn').addEventListener('click', closePreviewModal);
        document.getElementById('downloadPreviewPdfBtn').addEventListener('click', () => {
             // ใช้องค์ประกอบที่อยู่ใน preview modal สำหรับการสร้าง PDF
             const input = document.getElementById('previewContent').querySelector('#documentToCapture');
             if (input) {
                generatePdfFromElement(input);
             } else {
                showMessage('ไม่พบเนื้อหาเอกสารสำหรับการสร้าง PDF', true);
             }
        });

        // --- Capture Image Logic ---
        async function captureDocumentAsImage() {
            // ใช้ฟังก์ชัน Preview เพื่อสร้าง Clone ที่เป็น Non-Interactive ก่อน
            openPreviewModal(); 
            const input = document.getElementById('previewContent').querySelector('#documentToCapture');
            
            if (!input) {
                 showMessage('ไม่พบเนื้อหาเอกสารสำหรับการแคปหน้าจอ', true);
                 closePreviewModal();
                 return;
            }

            const docName = `${documentElements.docType.value}_${documentElements.docNumber.value || 'New'}.png`;

            try {
                document.getElementById('loadingOverlay').classList.remove('hidden');
                
                // ใช้ html2canvas กับ clone ที่เตรียมไว้แล้วใน modal
                const canvas = await html2canvas(input, { scale: 2, logging: false });
                const imgData = canvas.toDataURL('image/png');
                
                const link = document.createElement('a');
                link.href = imgData;
                link.download = docName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessage('แคปหน้าจอ (PNG) เรียบร้อยแล้ว!');

            } catch (error) {
                console.error("Image Capture Error:", error);
                showMessage('เกิดข้อผิดพลาดในการแคปหน้าจอ.', true);
            } finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
                closePreviewModal(); // ปิด modal หลัง capture
            }
        }
        
        // --- PDF Generation (Unified) ---
        window.jsPDF = window.jspdf.jsPDF; 

        function generatePdfFromElement(inputElement) {
            const docName = `${documentElements.docType.value}_${documentElements.docNumber.value || 'New'}.pdf`;

             html2canvas(inputElement, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgHeight = canvas.height * pdfWidth / canvas.width;

                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                heightLeft -= pdfHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= pdfHeight;
                }
                
                pdf.save(docName);
                showMessage('สร้างไฟล์ PDF เรียบร้อยแล้ว!');
            }).catch(error => {
                console.error("PDF Creation Error:", error);
                showMessage('เกิดข้อผิดพลาดในการสร้าง PDF. โปรดลองใหม่อีกครั้ง', true);
            });
        }
        
        // --- AI Logic (Gemini API Call) ---
        const apiKey = ""; 
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function generatePaymentDetails() {
            const btn = document.getElementById('generatePaymentBtn');
            const box = document.getElementById('paymentDetail');
            if (!btn || !box) {
                 console.error('AI Button or Textarea not found.');
                 return;
            }
            
            const originalText = btn.innerHTML;
            
            btn.disabled = true; 
            btn.innerHTML = `
                <svg class="animate-spin h-4 w-4 mr-1 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                กำลังสร้าง...
            `;
            box.placeholder = 'AI กำลังทำงาน...';
            
            const customerName = document.getElementById('customerName').value || 'ทั่วไป';
            const userQuery = `สร้างข้อความเงื่อนไขการชำระเงินสั้นๆ ทางการ สำหรับลูกค้า ${customerName} (มัดจำ 50% และส่วนที่เหลือชำระเมื่อส่งมอบ)`;
            const systemPrompt = "คุณคือผู้ช่วยมืออาชีพด้านการเงินและการออกเอกสาร ให้คำแนะนำเงื่อนไขการชำระเงินที่กระชับและชัดเจนที่สุดในภาษาไทย";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const res = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    
                    if (res.status === 429) {
                        if (attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            await sleep(delay);
                            continue; // Retry
                        } else {
                            throw new Error("Too many requests (429) and max retries reached.");
                        }
                    }

                    const data = await res.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (text) {
                        box.value = text.trim();
                        showMessage('สร้างเงื่อนไขการชำระเงินสำเร็จ!', false);
                    } else {
                        // Throw error if no text is returned
                         throw new Error(data.error?.message || 'ไม่สามารถสร้างข้อความได้');
                    }
                    break; // Success, exit loop

                } catch(e) { 
                    console.error("AI Generation Error (Attempt " + (attempt + 1) + "):", e);
                    if (attempt === maxRetries - 1) {
                         showMessage('ข้อผิดพลาดในการสร้างเงื่อนไข AI. กรุณาลองใหม่หรือพิมพ์เอง.', true);
                    }
                } 
            }
            
            // Reset UI
            btn.disabled = false; 
            btn.innerHTML = originalText; 
            box.placeholder = 'เช่น ชำระ 50% มัดจำ ส่วนที่เหลือชำระวันส่งมอบ';
            updateTotalsUI(); // Trigger UI update just in case
        }

        // --- Event Listeners and Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Initialize Firebase and Auth
            initFirebaseAndAuth();

            // 2. Set default date
            if (documentElements.docDate) {
                 documentElements.docDate.value = new Date().toISOString().substring(0, 10);
            }
           
            // 3. Add default item row and set up item container listeners
            const addItemBtn = document.getElementById('addItemBtn');
            if (addItemBtn) {
                addItemBtn.addEventListener('click', () => {
                    documentElements.itemsContainer.appendChild(createItemRow());
                    renumberItems();
                    updateTotalsUI();
                });
            }
            

            // 4. Global listeners for total calculation
            // Note: Listeners are added inside createItemRow for item-specific inputs.
            // This is for document level inputs (tax rate, etc.)
            Object.values(documentElements).forEach(el => {
                if (el && (el.id === 'taxRate' || el.id === 'documentType' || el.id === 'documentNumber')) {
                     el.addEventListener('input', updateTotalsUI);
                }
            });
            
            // 5. Control buttons listeners (Check for existence before adding listener)
            const newDocBtn = document.getElementById('newDocumentBtn');
            if (newDocBtn) newDocBtn.addEventListener('click', createNewDocument);
            
            const saveDocBtn = document.getElementById('saveDocumentBtn');
            if (saveDocBtn) saveDocBtn.addEventListener('click', saveDocument);
            
            const captureDocBtn = document.getElementById('captureDocumentBtn');
            if (captureDocBtn) captureDocBtn.addEventListener('click', captureDocumentAsImage);
            
            const printDocBtn = document.getElementById('printDocumentBtn');
            if (printDocBtn) printDocBtn.addEventListener('click', (e) => {
                e.preventDefault();
                openPreviewModal(); 
            });
            
            // 6. AI Button listener (for payment details generation)
            const generateAIBtn = document.getElementById('generatePaymentBtn');
            if (generateAIBtn) generateAIBtn.addEventListener('click', generatePaymentDetails);
        });
    </script>
</body>
</html>
