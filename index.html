<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ & ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à) ‡∏û‡∏£‡πâ‡∏≠‡∏° Firestore</title>
    <!-- ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ‡πÇ‡∏´‡∏•‡∏î Google Font Sarabun TH ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <!-- ‡πÇ‡∏´‡∏•‡∏î Library ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÅ‡∏•‡∏∞ Capture ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Font Sarabun TH ‡πÄ‡∏õ‡πá‡∏ô Font ‡∏´‡∏•‡∏±‡∏Å */
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f3f4f6;
        }
        /* Style ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö export) */
        #quotation-output, #receipt-output {
            background-color: white;
            padding: 2.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* Style ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ */
        .item-row input[type="text"], .item-row input[type="number"] {
            border: 1px solid #ccc;
            padding: 0.5rem;
            border-radius: 0.375rem;
        }
    </style>
</head>
<body>

    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
    <div class="max-w-7xl mx-auto p-4 lg:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ & Firestore üõ†Ô∏è</h1>
        
        <!-- ‡πÅ‡∏ñ‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ -->
        <div id="status-bar" class="p-3 mb-4 text-sm font-medium rounded-lg text-white bg-blue-500 shadow-lg hidden">
            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
        </div>

        <div class="bg-white p-6 rounded-xl shadow-2xl mb-6">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="document-id" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÇ‡∏´‡∏•‡∏î)" class="p-3 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <button id="save-btn" class="bg-green-600 text-white p-3 rounded-lg hover:bg-green-700 transition duration-150 disabled:bg-green-400" disabled>
                    <span id="save-text">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Save)</span>
                </button>
                <button id="load-btn" class="bg-yellow-600 text-white p-3 rounded-lg hover:bg-yellow-700 transition duration-150 disabled:bg-yellow-400" disabled>
                    <span id="load-text">‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Load)</span>
                </button>
            </div>
            <div id="user-info" class="mt-4 text-sm text-gray-500">
                User ID: <span id="user-id">...</span> | App ID: <span id="app-id">...</span>
            </div>
            <div id="document-list-container" class="mt-4 max-h-48 overflow-y-auto border p-3 rounded-lg bg-gray-50 hidden">
                <h3 class="font-medium text-gray-700 mb-2">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</h3>
                <ul id="document-list" class="space-y-1 text-sm">
                    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                </ul>
            </div>
        </div>


        <!-- ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ -->
        <div id="quotation-output" class="rounded-xl mx-auto w-full lg:w-3/4 mb-8">
            <div class="text-center mb-10">
                <h2 class="text-3xl font-bold text-blue-700 mb-1">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (Quotation)</h2>
                <input type="text" id="doc-title" value="‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó/‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" class="text-lg font-medium text-gray-600 text-center border-b-2 w-full p-1 focus:outline-none focus:border-blue-500">
            </div>

            <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ -->
            <div class="grid grid-cols-2 gap-4 mb-8 text-sm">
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
                    <textarea id="customer-info" rows="4" class="w-full border p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤, ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå, ‡∏≠‡∏µ‡πÄ‡∏°‡∏•"></textarea>
                </div>
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</h3>
                    <div class="space-y-1">
                        <p>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: <input type="text" id="quotation-no" value="QT-2025-001" class="border-b w-2/3 p-1 focus:outline-none"></p>
                        <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <input type="date" id="quotation-date" value="2025-01-01" class="border-b w-2/3 p-1 focus:outline-none"></p>
                        <p>‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: <input type="date" id="expiry-date" value="2025-01-31" class="border-b w-2/3 p-1 focus:outline-none"></p>
                    </div>
                </div>
            </div>

            <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
            <div class="mb-8 overflow-x-auto">
                <table class="min-w-full border-collapse">
                    <thead>
                        <tr class="bg-blue-500 text-white">
                            <th class="py-2 px-4 text-left w-1/12">#</th>
                            <th class="py-2 px-4 text-left w-5/12">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th class="py-2 px-4 text-center w-1/12">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                            <th class="py-2 px-4 text-right w-2/12">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                            <th class="py-2 px-4 text-right w-3/12">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</th>
                        </tr>
                    </thead>
                    <tbody id="item-list-body" class="bg-white">
                        <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
                    </tbody>
                    <tfoot>
                        <tr class="bg-gray-100">
                            <td colspan="4" class="py-2 px-4 text-right font-bold text-gray-700">‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (Subtotal)</td>
                            <td class="py-2 px-4 text-right font-bold text-gray-800" id="subtotal">0.00</td>
                        </tr>
                        <tr>
                            <td colspan="3" class="py-2 px-4 text-right text-sm text-gray-600">‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° (VAT %):</td>
                            <td class="py-2 px-4 text-right">
                                <input type="number" id="vat-rate" value="7" min="0" max="100" class="w-20 text-right border p-1 rounded-md" oninput="updateTotal()">
                            </td>
                            <td class="py-2 px-4 text-right font-medium text-gray-800" id="vat-amount">0.00</td>
                        </tr>
                        <tr>
                            <td colspan="3" class="py-2 px-4 text-right text-sm text-gray-600">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (Discount):</td>
                            <td class="py-2 px-4 text-right">
                                <input type="number" id="discount-amount" value="0" min="0" class="w-full text-right border p-1 rounded-md" oninput="updateTotal()">
                            </td>
                            <td class="py-2 px-4 text-right font-medium text-gray-800" id="discount-display">0.00</td>
                        </tr>
                        <tr class="bg-blue-100">
                            <td colspan="4" class="py-3 px-4 text-right font-bold text-blue-800 text-xl">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Grand Total)</td>
                            <td class="py-3 px-4 text-right font-bold text-blue-900 text-xl" id="grand-total">0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -->
            <div class="mb-8">
                <button id="add-item-btn" class="bg-gray-200 text-gray-700 p-2 rounded-lg hover:bg-gray-300 transition duration-150 text-sm flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                </button>
            </div>

            <!-- ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô -->
            <div class="grid grid-cols-2 gap-8 text-sm">
                <div>
                    <h3 class="font-semibold text-gray-700 mb-2">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
                    <textarea id="payment-detail" rows="4" class="w-full border p-2 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏ä‡πà‡∏ô: ‡∏ä‡∏≥‡∏£‡∏∞ 50% ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤, ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á)"></textarea>
                    <button id="generate-payment-detail-btn" class="mt-2 bg-blue-500 text-white p-2 text-xs rounded-lg hover:bg-blue-600 transition duration-150">
                        ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÇ‡∏î‡∏¢ Gemini AI
                    </button>
                </div>
                <div class="mt-8 text-center">
                    <p class="mb-10 border-b-2 border-gray-400 w-3/4 mx-auto"></p>
                    <p class="font-semibold text-gray-700">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥ (Authorized Signature)</p>
                </div>
            </div>
        </div>

        <!-- ‡∏õ‡∏∏‡πà‡∏° Export ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• -->
        <div class="text-center mt-10">
            <button id="export-pdf-btn" class="bg-red-600 text-white text-lg p-3 rounded-lg hover:bg-red-700 transition duration-150 shadow-xl">
                Export ‡πÄ‡∏õ‡πá‡∏ô PDF
            </button>
            <button id="toggle-type-btn" class="bg-purple-600 text-white text-lg p-3 rounded-lg hover:bg-purple-700 transition duration-150 shadow-xl ml-4">
                ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ
            </button>
        </div>
    </div>

    <!-- Firebase Imports (‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ type="module") -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Debug Log ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Firestore
        setLogLevel('debug');

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Global Variables ‡∏ó‡∏µ‡πà Canvas ‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'loading';
        let isAuthReady = false;

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
        async function setupFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                document.getElementById('status-bar').textContent = '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö Firebase Config';
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                document.getElementById('app-id').textContent = appId;
                document.getElementById('user-id').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô...';
                document.getElementById('status-bar').textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase...';
                document.getElementById('status-bar').classList.replace('bg-blue-500', 'bg-yellow-600');
                document.getElementById('status-bar').classList.remove('hidden');

                // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
                let resolveAuth;
                const authPromise = new Promise(resolve => { resolveAuth = resolve; });

                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id').textContent = userId;
                        isAuthReady = true;
                        document.getElementById('status-bar').textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠: ' + userId;
                        document.getElementById('status-bar').classList.replace('bg-yellow-600', 'bg-green-600');
                        document.getElementById('save-btn').disabled = false;
                        document.getElementById('load-btn').disabled = false;
                        document.getElementById('document-list-container').classList.remove('hidden');
                        unsubscribe(); // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ü‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                        resolveAuth();
                    } else {
                        // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ Token ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏±‡∏ß‡∏ï‡∏ô
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

                await authPromise; // ‡∏£‡∏≠‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô‡∏à‡∏∞‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
                loadDocumentList(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å Auth ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß

            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
                document.getElementById('status-bar').textContent = '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase: ' + error.message;
                document.getElementById('status-bar').classList.replace('bg-yellow-600', 'bg-red-600');
            }
        }

        // --- Firestore Data Operations ---

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏±‡∏ö Collection Reference ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (Private Data)
        function getDocumentCollectionRef() {
            if (!db || !userId || userId === 'loading') throw new Error("Firestore not ready or user ID missing.");
            // Path: /artifacts/{appId}/users/{userId}/sales_documents
            return collection(db, 'artifacts', appId, 'users', userId, 'sales_documents');
        }

        // 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å UI
        function getCurrentDocumentData() {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
            const items = Array.from(document.querySelectorAll('.item-row')).map((row, index) => {
                return {
                    id: row.id,
                    description: row.querySelector(`#description-${index + 1}`).value,
                    quantity: parseFloat(row.querySelector(`#quantity-${index + 1}`).value) || 0,
                    unitPrice: parseFloat(row.querySelector(`#unit-price-${index + 1}`).value) || 0
                };
            });

            const docId = document.getElementById('document-id').value.trim() || `DOC-${Date.now()}`;

            return {
                documentId: docId,
                type: document.getElementById('quotation-output').querySelector('h2').textContent.includes('‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤') ? 'Quotation' : 'Receipt',
                docTitle: document.getElementById('doc-title').value,
                customerInfo: document.getElementById('customer-info').value,
                docNo: document.getElementById('quotation-no').value,
                docDate: document.getElementById('quotation-date').value,
                expiryDate: document.getElementById('expiry-date').value,
                vatRate: parseFloat(document.getElementById('vat-rate').value) || 0,
                discountAmount: parseFloat(document.getElementById('discount-amount').value) || 0,
                paymentDetail: document.getElementById('payment-detail').value,
                items: items,
                updatedAt: new Date().toISOString()
            };
        }

        // 2. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
        async function saveDocument() {
            const btn = document.getElementById('save-btn');
            const originalText = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Save)';
            if (!isAuthReady || btn.disabled) return;

            btn.disabled = true;
            btn.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

            try {
                const data = getCurrentDocumentData();
                let docId = data.documentId;
                
                // ‡∏´‡∏≤‡∏Å Document ID ‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÉ‡∏´‡∏°‡πà
                if (docId.startsWith('DOC-')) {
                    docId = `DOC-${Date.now()}`;
                    document.getElementById('document-id').value = docId;
                }

                const docRef = doc(getDocumentCollectionRef(), docId);
                await setDoc(docRef, data);

                document.getElementById('status-bar').textContent = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ "${docId}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`;
                document.getElementById('status-bar').classList.replace('bg-red-600', 'bg-green-600');
                loadDocumentList(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å

            } catch (error) {
                console.error("Error saving document:", error);
                document.getElementById('status-bar').textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ${error.message}`;
                document.getElementById('status-bar').classList.replace('bg-green-600', 'bg-red-600');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // 3. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firestore ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô UI)
        window.loadDocument = async function(docId) {
            const btn = document.getElementById('load-btn');
            const originalText = '‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Load)';
            if (!isAuthReady) return;

            let targetId = docId || document.getElementById('document-id').value.trim();

            if (!targetId) {
                document.getElementById('status-bar').textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î';
                document.getElementById('status-bar').classList.replace('bg-green-600', 'bg-red-600');
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';

            try {
                const docRef = doc(getDocumentCollectionRef(), targetId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    populateForm(data);
                    document.getElementById('document-id').value = targetId; // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó ID ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏•‡∏î
                    document.getElementById('status-bar').textContent = `‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ "${targetId}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`;
                    document.getElementById('status-bar').classList.replace('bg-red-600', 'bg-green-600');
                } else {
                    document.getElementById('status-bar').textContent = `‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ID: "${targetId}"`;
                    document.getElementById('status-bar').classList.replace('bg-green-600', 'bg-red-600');
                }

            } catch (error) {
                console.error("Error loading document:", error);
                document.getElementById('status-bar').textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î: ${error.message}`;
                document.getElementById('status-bar').classList.replace('bg-green-600', 'bg-red-600');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // 4. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
        function loadDocumentList() {
            if (!isAuthReady) return;

            const listEl = document.getElementById('document-list');
            listEl.innerHTML = '';

            // ‡πÉ‡∏ä‡πâ onSnapshot ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏ö‡∏ö Real-time
            onSnapshot(getDocumentCollectionRef(), (snapshot) => {
                listEl.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°
                if (snapshot.empty) {
                    listEl.innerHTML = `<li class="text-gray-500 italic">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</li>`;
                    return;
                }

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const docId = doc.id;
                    const docTitle = data.docTitle || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠';
                    
                    const listItem = document.createElement('li');
                    listItem.classList.add('flex', 'justify-between', 'items-center', 'py-1', 'border-b', 'last:border-b-0');
                    listItem.innerHTML = `
                        <span class="text-xs text-gray-800 font-medium truncate w-1/2">${docId}</span>
                        <span class="text-xs text-gray-600 truncate w-1/4 ml-2">${docTitle}</span>
                        <div class="ml-auto flex space-x-2">
                            <button onclick="loadDocument('${docId}')" class="text-blue-500 hover:text-blue-700 text-xs font-semibold px-2 py-1 rounded transition">
                                ‡πÇ‡∏´‡∏•‡∏î
                            </button>
                            <button onclick="deleteDocument('${docId}')" class="text-red-500 hover:text-red-700 text-xs font-semibold px-2 py-1 rounded transition">
                                ‡∏•‡∏ö
                            </button>
                        </div>
                    `;
                    listEl.appendChild(listItem);
                });
            }, (error) => {
                console.error("Error listening to document list:", error);
                document.getElementById('status-bar').textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: ${error.message}`;
                document.getElementById('status-bar').classList.replace('bg-green-600', 'bg-red-600');
            });
        }

        // 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
        window.deleteDocument = async function(docId) {
            if (!isAuthReady) return;

            // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà alert/confirm ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô console/UI
            if (!confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ID: ${docId}?`)) {
                return;
            }
            
            try {
                const docRef = doc(getDocumentCollectionRef(), docId);
                await deleteDoc(docRef);
                document.getElementById('status-bar').textContent = `‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ "${docId}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`;
                document.getElementById('status-bar').classList.replace('bg-red-600', 'bg-green-600');
                // loadDocumentList ‡∏à‡∏∞‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å onSnapshot
            } catch (error) {
                console.error("Error deleting document:", error);
                document.getElementById('status-bar').textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö: ${error.message}`;
                document.getElementById('status-bar').classList.replace('bg-green-600', 'bg-red-600');
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≤‡∏Å Firestore
        function populateForm(data) {
            document.getElementById('quotation-output').querySelector('h2').textContent = 
                data.type === 'Quotation' ? '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (Quotation)' : '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ (Receipt)';
            
            document.getElementById('doc-title').value = data.docTitle || '';
            document.getElementById('customer-info').value = data.customerInfo || '';
            document.getElementById('quotation-no').value = data.docNo || '';
            document.getElementById('quotation-date').value = data.docDate || '';
            document.getElementById('expiry-date').value = data.expiryDate || '';
            document.getElementById('vat-rate').value = data.vatRate || 0;
            document.getElementById('discount-amount').value = data.discountAmount || 0;
            document.getElementById('payment-detail').value = data.paymentDetail || '';
            
            // ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°
            const itemListBody = document.getElementById('item-list-body');
            itemListBody.innerHTML = '';
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
            data.items.forEach((item, index) => {
                addItem(item.description, item.quantity, item.unitPrice, index + 1);
            });
            
            updateTotal(); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase ‡πÄ‡∏°‡∏∑‡πà‡∏≠ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
        document.addEventListener('DOMContentLoaded', setupFirebase);
    </script>

    <!-- JavaScript ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö UI ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì -->
    <script>
        window.jsPDF = window.jspdf.jsPDF; // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ jspdf

        let itemCounter = 0; // ‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ID ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤

        document.addEventListener('DOMContentLoaded', () => {
            // ‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 3 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            for (let i = 0; i < 3; i++) {
                addItem();
            }

            // ‡πÅ‡∏ô‡∏ö Event Listeners ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å
            document.getElementById('add-item-btn').addEventListener('click', () => addItem());
            document.getElementById('export-pdf-btn').addEventListener('click', exportPDF);
            document.getElementById('toggle-type-btn').addEventListener('click', toggleDocumentType);
            document.getElementById('generate-payment-detail-btn').addEventListener('click', generatePaymentDetail);
            
            // ‡πÅ‡∏ô‡∏ö Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Firestore
            document.getElementById('save-btn').addEventListener('click', () => saveDocument());
            document.getElementById('load-btn').addEventListener('click', () => window.loadDocument());

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
            updateTotal();
        });

        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏≤‡∏Ñ‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á) ---

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        function addItem(description = '', quantity = 1, unitPrice = 0, index) {
            itemCounter++;
            const itemNumber = index !== undefined ? index : itemCounter;
            const itemListBody = document.getElementById('item-list-body');
            
            const newRow = document.createElement('tr');
            newRow.className = 'item-row border-t border-gray-200';
            newRow.id = `item-${itemNumber}`;
            newRow.innerHTML = `
                <td class="py-2 px-4 text-center text-gray-500">${itemNumber}</td>
                <td class="py-2 px-4">
                    <input type="text" id="description-${itemNumber}" value="${description}" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£" class="w-full text-sm focus:border-blue-500 focus:ring-0">
                </td>
                <td class="py-2 px-4 text-center">
                    <input type="number" id="quantity-${itemNumber}" value="${quantity}" min="1" class="w-16 text-center text-sm focus:border-blue-500 focus:ring-0" oninput="updateTotal()">
                </td>
                <td class="py-2 px-4 text-right">
                    <input type="number" id="unit-price-${itemNumber}" value="${unitPrice}" min="0" step="0.01" class="w-24 text-right text-sm focus:border-blue-500 focus:ring-0" oninput="updateTotal()">
                </td>
                <td class="py-2 px-4 text-right font-medium" id="total-price-${itemNumber}">0.00</td>
                <td class="py-2 px-1 text-center w-1/12">
                    <button onclick="deleteItem('${newRow.id}')" class="text-red-500 hover:text-red-700 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </td>
            `;
            itemListBody.appendChild(newRow);

            // ‡πÅ‡∏ô‡∏ö Event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input text ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            newRow.querySelector(`#quantity-${itemNumber}`).addEventListener('input', updateTotal);
            newRow.querySelector(`#unit-price-${itemNumber}`).addEventListener('input', updateTotal);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        window.deleteItem = function(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                updateTotal(); // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏ö
                // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                const rows = document.querySelectorAll('.item-row');
                rows.forEach((r, index) => {
                    r.querySelector('td:first-child').textContent = index + 1;
                });
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏±‡πä‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì)
        window.updateTotal = function() {
            let subtotal = 0;
            const itemRows = document.querySelectorAll('.item-row');
            
            itemRows.forEach((row, index) => {
                const itemNumber = index + 1;
                const quantityInput = row.querySelector(`#quantity-${itemNumber}`);
                const unitPriceInput = row.querySelector(`#unit-price-${itemNumber}`);
                const totalPriceEl = row.querySelector(`#total-price-${itemNumber}`);
                
                // ‡πÉ‡∏ä‡πâ parseFloat ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö NaN ‡πÉ‡∏´‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                const quantity = parseFloat(quantityInput?.value) || 0;
                const unitPrice = parseFloat(unitPriceInput?.value) || 0;
                
                const itemTotal = quantity * unitPrice;
                
                totalPriceEl.textContent = itemTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                subtotal += itemTotal;
            });

            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ
            const vatRate = parseFloat(document.getElementById('vat-rate').value) || 0;
            const discountAmount = parseFloat(document.getElementById('discount-amount').value) || 0;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì VAT
            const vatAmount = (subtotal * vatRate) / 100;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥
            let grandTotal = subtotal + vatAmount - discountAmount;
            if (grandTotal < 0) grandTotal = 0; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏ö

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            document.getElementById('subtotal').textContent = subtotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            document.getElementById('vat-amount').textContent = vatAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            document.getElementById('discount-display').textContent = discountAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            document.getElementById('grand-total').textContent = grandTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô AI (‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°) ---
        
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏î‡πâ‡∏ß‡∏¢ Exponential Backoff
        async function fetchWithExponentialBackoff(url, options) {
            const maxRetries = 5;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) { // Too Many Requests
                            throw new Error('Rate limit exceeded. Retrying...');
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Gemini
        async function generatePaymentDetail() {
            const btn = document.getElementById('generate-payment-detail-btn');
            const paymentDetailEl = document.getElementById('payment-detail');
            const originalHtml = btn.innerHTML;
            
            const subtotal = document.getElementById('subtotal').textContent;
            const grandTotal = document.getElementById('grand-total').textContent;

            // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI Prompt
            const itemRows = document.querySelectorAll('.item-row');
            const itemDetails = Array.from(itemRows).map((row, index) => {
                const desc = row.querySelector(`#description-${index + 1}`).value;
                const total = row.querySelector(`#total-price-${index + 1}`).textContent;
                return `${desc} (‡∏£‡∏ß‡∏°: ${total} ‡∏ö‡∏≤‡∏ó)`;
            }).join('; ');
            
            const userPrompt = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡∏µ‡πâ: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏≠ ${itemDetails} ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ñ‡∏∑‡∏≠ ${grandTotal} ‡∏ö‡∏≤‡∏ó (‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏¢‡πà‡∏≠‡∏¢ ${subtotal} ‡∏ö‡∏≤‡∏ó) ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ ‡πÄ‡∏ô‡πâ‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏±‡∏î‡∏à‡∏≥ 50% ‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô. ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô`;
            
            const systemPrompt = "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô. ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö";
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            btn.disabled = true;
            btn.innerHTML = '<span class="animate-spin inline-block mr-2">‚öôÔ∏è</span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...';
            paymentDetailEl.placeholder = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å AI...';

            try {
                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    config: { temperature: 0.4 }
                };

                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    paymentDetailEl.value = generatedText.trim();
                } else {
                    console.error('Gemini API returned no text.', result);
                    const message = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà (API Error)';
                    document.getElementById('status-bar').textContent = message;
                    document.getElementById('status-bar').classList.replace('bg-green-600', 'bg-red-600');
                }

            } catch (error) {
                console.error('Error generating payment details:', error);
                const message = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏ã‡∏• (Connection Error)';
                document.getElementById('status-bar').textContent = message;
                document.getElementById('status-bar').classList.replace('bg-green-600', 'bg-red-600');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
                paymentDetailEl.placeholder = '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏ä‡πà‡∏ô: ‡∏ä‡∏≥‡∏£‡∏∞ 50% ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤, ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á)';
            }
        }
        
        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Export PDF (‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°) ---

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
        function toggleDocumentType() {
            const h2 = document.getElementById('quotation-output').querySelector('h2');
            const button = document.getElementById('toggle-type-btn');

            if (h2.textContent.includes('‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤')) {
                h2.textContent = '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ (Receipt/Tax Invoice)';
                button.textContent = '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤';
            } else {
                h2.textContent = '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (Quotation)';
                button.textContent = '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à/‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ';
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Export ‡πÄ‡∏õ‡πá‡∏ô PDF
        function exportPDF() {
            const outputElement = document.getElementById('quotation-output');
            const docTitle = outputElement.querySelector('h2').textContent.split(' ')[0] || 'Document';
            
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô Capture
            document.querySelectorAll('.item-row button').forEach(btn => btn.style.display = 'none');
            
            html2canvas(outputElement, { 
                scale: 2, 
                useCORS: true,
                logging: false,
                // ‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° input ‡∏Å‡πà‡∏≠‡∏ô Capture
                onclone: (doc) => {
                    doc.querySelectorAll('input, textarea, button').forEach(el => {
                        el.style.border = 'none';
                        el.style.boxShadow = 'none';
                        el.style.outline = 'none';
                        // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                        if (el.tagName === 'BUTTON' && el.parentElement.parentElement.classList.contains('item-row')) {
                            el.style.display = 'none';
                        }
                    });
                    // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ô‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                    doc.querySelector('#doc-title').style.textAlign = 'center';
                }
            }).then(canvas => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/png');
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`${docTitle}-${document.getElementById('quotation-no').value}.pdf`);

                // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
                document.querySelectorAll('.item-row button').forEach(btn => btn.style.display = 'block');
            });
        }
    </script>

</body>
</html>
