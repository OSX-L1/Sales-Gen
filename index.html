<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ & ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à) + ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</title>
    
    <!-- ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ‡πÇ‡∏´‡∏•‡∏î Google Font Sarabun TH -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <!-- ‡πÇ‡∏´‡∏•‡∏î Library ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PDF/Capture -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- ‡πÇ‡∏´‡∏•‡∏î Firebase SDK (‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô compat ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        
        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ Desktop/A4 (Default) */
        .document-container {
            width: 21cm; /* A4 width */
            min-height: 29.7cm; /* A4 height */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background: white;
            margin: 20px auto;
            transition: all 0.3s ease-in-out; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏∏‡πà‡∏°‡∏ô‡∏ß‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î */
        }

        /* Mobile View Mode Styles (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏≤‡∏™‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏î‡∏¢ JS) */
        .document-container.mobile-mode-active {
            width: 100% !important; /* Override fixed width */
            min-height: auto !important; /* No fixed height */
            box-shadow: none !important; /* Remove shadow */
            margin: 0 !important; /* Remove center margin */
            padding: 1rem !important; /* Smaller padding for mobile */
        }
        
        /* ‡∏õ‡∏£‡∏±‡∏ö padding ‡∏Ç‡∏≠‡∏á Main container ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î Mobile ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ */
        main.mobile-mode-active-padding {
            padding: 0 !important; /* Remove main padding for full screen mobile */
        }
        
        /* Adjust padding inside the document container when in mobile mode */
        .document-container.mobile-mode-active > div:first-child {
            padding: 1rem !important;
        }

        /* ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå */
        @media print {
            .sidebar-controls, .controls-container, .document-footer, .action-buttons {
                display: none !important;
            }
            .document-container {
                margin: 0;
                box-shadow: none;
                width: 100%;
                min-height: 100vh;
            }
        }
        /* ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏°‡∏∏‡∏ô‡πÉ‡∏ô input type=number */
        input[type="number"]::-webkit-inner-spin-button, 
        input[type="number"]::-webkit-outer-spin-button { 
            -webkit-appearance: none; margin: 0; 
        }
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å */
        .item-row input, .item-row select, .item-row textarea {
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.875rem; /* text-sm */
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col lg:flex-row min-h-screen">
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="text-white text-lg flex flex-col items-center">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
        </div>
    </div>

    <!-- ‡∏™‡πà‡∏ß‡∏ô Sidebar/Controls ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Mobile/Desktop -->
    <div class="sidebar-controls bg-white p-4 w-full lg:w-72 lg:min-h-screen border-r border-gray-200 shadow-lg flex flex-col">
        <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</h2>
        <div id="userIdDisplay" class="text-sm text-gray-600 mb-4 p-2 bg-gray-100 rounded-lg">
            User ID: <span id="currentUserId" class="font-mono break-all text-blue-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
        </div>

        <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ -->
        <ul id="documentList" class="space-y-2 flex-grow overflow-y-auto pb-4">
            <li class="text-gray-500 italic">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</li>
        </ul>

        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏´‡∏•‡∏±‡∏Å -->
        <div class="controls-container mt-4 pt-4 border-t border-gray-200 space-y-3">
            <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏•‡∏±‡∏ö‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á (Desktop/Mobile) -->
            <button id="toggleViewModeBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md flex items-center justify-center">
                <span id="viewModeIcon">üíª</span>
                <span class="ml-2" id="viewModeText">‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏î‡∏™‡∏Å‡πå‡∏ó‡πá‡∏≠‡∏õ (A4)</span>
            </button>
            
            <button id="newDocumentBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                <i class="fas fa-plus mr-2"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
            </button>
            <button id="saveDocumentBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                <i class="fas fa-save mr-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
            </button>
            <button id="previewDocumentBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                <i class="fas fa-eye mr-2"></i> ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤
            </button>
            <button id="captureDocumentBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                <i class="fas fa-camera mr-2"></i> ‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (PNG)
            </button>
            <button id="printDocumentBtn" class="w-full bg-red-500 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                <i class="fas fa-print mr-2"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå / ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF
            </button>
            <div id="messageBox" class="p-3 bg-indigo-100 text-indigo-800 text-sm rounded-lg hidden transition duration-300"></div>
        </div>
    </div>

    <!-- ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ -->
    <main id="mainContainer" class="flex-grow p-4 lg:p-8 overflow-y-auto">
        
        <!-- Document Container (A4 Mockup) -->
        <div id="documentToCapture" class="document-container p-6 md:p-10 lg:p-12 shadow-xl">

            <!-- Header and Type Selector -->
            <div class="flex flex-col sm:flex-row justify-between items-start border-b-4 border-indigo-600 pb-4 mb-6">
                <div class="flex flex-col">
                    <input type="text" id="companyName" value="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" class="text-2xl sm:text-3xl font-bold mb-1 p-1" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó">
                    <textarea id="companyAddress" class="text-sm text-gray-600 w-full p-1 h-12 resize-none" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå"></textarea>
                </div>
                <div class="mt-4 sm:mt-0 flex-shrink-0">
                    <select id="documentType" class="text-xl font-bold text-center p-2 rounded-lg border-2 border-gray-300 bg-gray-100">
                        <option value="‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤">‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</option>
                        <option value="‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</option>
                    </select>
                </div>
            </div>

            <!-- Customer and Document Info -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-sm">
                <div class="col-span-1 md:col-span-2 space-y-2 p-3 border rounded-lg bg-gray-50">
                    <div class="flex items-center">
                        <label class="w-24 font-semibold">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</label>
                        <input type="text" id="customerName" class="flex-grow p-1" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó">
                    </div>
                    <div class="flex items-start">
                        <label class="w-24 font-semibold">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</label>
                        <textarea id="customerAddress" class="flex-grow p-1 h-10 resize-none" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"></textarea>
                    </div>
                    <div class="flex items-center">
                        <label class="w-24 font-semibold">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:</label>
                        <input type="text" id="customerContact" class="flex-grow p-1" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£/‡∏≠‡∏µ‡πÄ‡∏°‡∏•">
                    </div>
                </div>
                <div class="col-span-1 space-y-2 p-3 border rounded-lg bg-gray-50">
                    <div class="flex items-center">
                        <label class="w-24 font-semibold">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</label>
                        <input type="text" id="documentNumber" class="flex-grow p-1" placeholder="QUO-001/2567">
                    </div>
                    <div class="flex items-center">
                        <label class="w-24 font-semibold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                        <input type="date" id="documentDate" class="flex-grow p-1">
                    </div>
                    <div class="flex items-center">
                        <label class="w-24 font-semibold">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏≥‡∏£‡∏∞:</label>
                        <input type="date" id="dueDate" class="flex-grow p-1">
                    </div>
                </div>
            </div>

            <!-- Items Table Header (Updated to include Category/Dimensions) -->
            <!-- ‡πÉ‡∏ä‡πâ text-xs ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Ñ‡∏ö‡∏•‡∏á‡πÉ‡∏ô PDF/Preview -->
            <div class="flex text-xs md:text-sm font-bold bg-indigo-600 text-white rounded-t-lg p-2 mt-8">
                <span class="w-8 text-center">#</span>
                <span class="w-28 text-center">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</span>
                <span class="w-16 text-center">‡∏£‡∏´‡∏±‡∏™</span>
                <span class="flex-grow ml-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
                <span class="w-12 text-center">‡∏Å‡∏ß‡πâ‡∏≤‡∏á</span>
                <span class="w-12 text-center">‡∏™‡∏π‡∏á</span>
                <span class="w-12 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</span>
                <span class="w-16 text-right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</span>
                <span class="w-20 text-right">‡∏£‡∏ß‡∏° (‡∏ö‡∏≤‡∏ó)</span>
                <span class="w-8 text-center">‡∏•‡∏ö</span>
            </div>

            <!-- Items Table Body -->
            <div id="itemsContainer" class="border border-gray-300 border-t-0 text-sm">
                <!-- Item Rows will be inserted here -->
            </div>
            
            <!-- Add Item Button -->
            <button id="addItemBtn" class="w-full text-indigo-600 hover:text-indigo-800 border-b border-l border-r border-gray-300 py-2 transition duration-150 text-sm font-semibold">
                + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            </button>
            
            <!-- Summary and Totals -->
            <div class="flex flex-wrap mt-6">
                <!-- Payment Details & Notes -->
                <div class="w-full lg:w-2/3 pr-0 lg:pr-4 mb-4 lg:mb-0">
                    <h3 class="text-md font-bold mb-2">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</h3>
                    <div class="relative mb-2">
                         <textarea id="paymentDetail" rows="4" class="w-full p-2 border rounded-lg text-sm bg-white resize-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏≥‡∏£‡∏∞ 50% ‡∏°‡∏±‡∏î‡∏à‡∏≥ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡∏ß‡∏±‡∏ô‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö"></textarea>
                        <button id="generatePaymentBtn" class="absolute top-1 right-1 bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-2 rounded-full transition duration-150 shadow-md">
                            AI ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á
                        </button>
                    </div>
                   
                    <textarea id="documentNote" rows="2" class="w-full p-2 border rounded-lg text-sm bg-white resize-none" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
                </div>
                
                <!-- Totals -->
                <div class="w-full lg:w-1/3 bg-gray-50 p-4 border rounded-lg shadow-inner">
                    <div class="flex justify-between mb-2">
                        <span class="font-semibold">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ):</span>
                        <span id="subTotal" class="font-semibold">0.00</span>
                    </div>
                    <div class="flex justify-between mb-2 items-center">
                        <label class="font-semibold flex items-center">‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° 
                            <input type="number" id="taxRate" value="7" min="0" max="100" class="w-12 text-right ml-2 border p-0.5 rounded text-sm"> %:
                        </label>
                        <span id="taxAmount" class="font-semibold text-red-600">0.00</span>
                    </div>
                    <div class="flex justify-between border-t border-gray-300 pt-3 mt-3">
                        <span class="text-xl font-bold text-indigo-600">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</span>
                        <span id="grandTotal" class="text-xl font-bold text-indigo-600">0.00</span>
                    </div>
                </div>
            </div>

            <!-- Footer (Signatures) -->
            <div class="document-footer grid grid-cols-2 gap-8 mt-16 text-sm">
                <div class="text-center">
                    <div class="mt-12 border-b border-gray-400 w-3/4 mx-auto pb-1"></div>
                    <p class="mt-2">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠)</p>
                    <p>(................................................)</p>
                </div>
                <div class="text-center">
                    <div class="mt-12 border-b border-gray-400 w-3/4 mx-auto pb-1"></div>
                    <p class="mt-2">‡∏ú‡∏π‡πâ‡∏≠‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠)</p>
                    <p>(................................................)</p>
                </div>
            </div>

        </div>
    </main>

    <!-- Modal: Preview/Delete Confirmation -->
    
    <!-- Delete Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-80">
            <h3 class="text-lg font-bold mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
            <p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ "<span id="docToDeleteName" class="font-semibold text-red-600"></span>" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ</p>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="cancelDeleteBtn" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-lg text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm">‡∏•‡∏ö</button>
            </div>
        </div>
    </div>
    
    <!-- Preview Modal -->
    <div id="previewModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 items-center justify-center hidden">
        <div class="bg-white p-2 md:p-4 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex justify-between items-center border-b pb-2 mb-2">
                 <h3 class="text-lg font-bold">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</h3>
                 <button id="closePreviewBtn" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
            </div>
            <div id="previewContent" class="flex-grow overflow-y-auto p-4 border rounded-lg bg-gray-50">
                <!-- Document content will be cloned here -->
            </div>
            <div class="mt-4 flex justify-end">
                <button id="downloadPreviewPdfBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm shadow-md">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô PDF</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- Global Variables (Provided by Canvas) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let currentDocumentId = null;
        let currentDocumentData = {};
        let isMobileMode = false; // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÇ‡∏´‡∏°‡∏î Mobile

        const CATEGORIES = [
            { value: '‡∏â‡∏≤‡∏Å PVC', label: '‡∏â‡∏≤‡∏Å PVC' },
            { value: '‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô', label: '‡∏°‡πà‡∏≤‡∏ô‡∏°‡πâ‡∏ß‡∏ô' },
            { value: '‡∏°‡∏π‡πà‡∏•‡∏µ‡πà‡πÑ‡∏°‡πâ', label: '‡∏°‡∏π‡πà‡∏•‡∏µ‡πà‡πÑ‡∏°‡πâ' },
            { value: '‡∏°‡∏π‡πà‡∏•‡∏µ‡πà‡∏≠‡∏•‡∏π‡∏°‡∏¥‡πÄ‡∏ô‡∏µ‡∏¢‡∏°', label: '‡∏°‡∏π‡πà‡∏•‡∏µ‡πà‡∏≠‡∏•‡∏π‡∏°‡∏¥‡πÄ‡∏ô‡∏µ‡∏¢‡∏°' }
        ];

        const documentElements = {
            docType: document.getElementById('documentType'),
            companyName: document.getElementById('companyName'),
            companyAddress: document.getElementById('companyAddress'),
            customerName: document.getElementById('customerName'),
            customerAddress: document.getElementById('customerAddress'),
            customerContact: document.getElementById('customerContact'),
            docNumber: document.getElementById('documentNumber'),
            docDate: document.getElementById('documentDate'),
            dueDate: document.getElementById('dueDate'),
            paymentDetail: document.getElementById('paymentDetail'),
            documentNote: document.getElementById('documentNote'),
            taxRate: document.getElementById('taxRate'),
            itemsContainer: document.getElementById('itemsContainer'),
            subTotal: document.getElementById('subTotal'),
            taxAmount: document.getElementById('taxAmount'),
            grandTotal: document.getElementById('grandTotal'),
        };
        
        // Element ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÇ‡∏´‡∏°‡∏î
        const mainContainer = document.getElementById('mainContainer');
        const documentToCapture = document.getElementById('documentToCapture');
        const toggleViewModeBtn = document.getElementById('toggleViewModeBtn');
        const viewModeIcon = document.getElementById('viewModeIcon');
        const viewModeText = document.getElementById('viewModeText');


        // --- Utility Functions ---

        /** ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß */
        function showMessage(text, isError = false) {
            const msg = document.getElementById('messageBox');
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ element ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£
            if (!msg) {
                console.warn('Message box element not found.');
                return;
            }
            msg.textContent = text;
            msg.classList.remove('hidden', 'bg-red-100', 'text-red-800', 'bg-indigo-100', 'text-indigo-800');
            msg.classList.add(isError ? 'bg-red-100' : 'bg-indigo-100', isError ? 'text-red-800' : 'text-indigo-800');
            setTimeout(() => {
                msg.classList.add('hidden');
            }, 3000);
        }

        /** ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å UI Elements ‡∏°‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Object */
        function getDocumentDataFromUI() {
            const items = Array.from(documentElements.itemsContainer.querySelectorAll('.item-row')).map(row => {
                // ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ try-catch ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤ ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô input ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô undefined
                try {
                    return {
                        category: row.querySelector('select[name="category"]').value, 
                        productCode: row.querySelector('input[name="productCode"]').value,
                        description: row.querySelector('textarea[name="description"]').value,
                        // ‡πÉ‡∏ä‡πâ parseFloat() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å input string ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                        width: parseFloat(row.querySelector('input[name="width"]').value) || 0,
                        height: parseFloat(row.querySelector('input[name="height"]').value) || 0,
                        quantity: parseFloat(row.querySelector('input[name="quantity"]').value) || 0,
                        unitPrice: parseFloat(row.querySelector('input[name="unitPrice"]').value) || 0,
                        id: row.dataset.id
                    };
                } catch (e) {
                    console.error("Error reading item row data:", e);
                    return null;
                }
            }).filter(item => item !== null);

            const data = {
                documentType: documentElements.docType?.value || '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤',
                companyName: documentElements.companyName?.value || '‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì',
                companyAddress: documentElements.companyAddress?.value || '',
                customerName: documentElements.customerName?.value || '',
                customerAddress: documentElements.customerAddress?.value || '',
                customerContact: documentElements.customerContact?.value || '',
                documentNumber: documentElements.docNumber?.value || '',
                documentDate: documentElements.docDate?.value || '',
                dueDate: documentElements.dueDate?.value || '',
                paymentDetail: documentElements.paymentDetail?.value || '',
                documentNote: documentElements.documentNote?.value || '',
                taxRate: parseFloat(documentElements.taxRate?.value) || 0,
                items: items,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            const totals = calculateTotals(data.items, data.taxRate);
            return { ...data, ...totals };
        }

        /** ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
        function calculateTotals(items, taxRate) {
            const subTotal = items.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
            
            const rate = (taxRate || 0) / 100;
            const taxAmount = subTotal * rate;
            const grandTotal = subTotal + taxAmount;
            
            return {
                subTotal: parseFloat(subTotal.toFixed(2)),
                taxAmount: parseFloat(taxAmount.toFixed(2)),
                grandTotal: parseFloat(grandTotal.toFixed(2))
            };
        }

        /** ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤ Total ‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡∏°‡πà */
        function updateTotalsUI() {
             try {
                const data = getDocumentDataFromUI();
                
                documentElements.subTotal.textContent = data.subTotal.toLocaleString('th-TH', { minimumFractionDigits: 2 });
                documentElements.taxAmount.textContent = data.taxAmount.toLocaleString('th-TH', { minimumFractionDigits: 2 });
                documentElements.grandTotal.textContent = data.grandTotal.toLocaleString('th-TH', { minimumFractionDigits: 2 });
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏•‡∏£‡∏ß‡∏°‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ñ‡∏ß
                documentElements.itemsContainer.querySelectorAll('.item-row').forEach(row => {
                    const quantity = parseFloat(row.querySelector('input[name="quantity"]').value) || 0;
                    const unitPrice = parseFloat(row.querySelector('input[name="unitPrice"]').value) || 0;
                    const total = (quantity * unitPrice).toFixed(2);
                    row.querySelector('.item-total').textContent = parseFloat(total).toLocaleString('th-TH', { minimumFractionDigits: 2 });
                });
                
                document.querySelector('title').textContent = `${data.documentType} | ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢`;
            } catch (e) {
                console.error("Error updating totals UI:", e);
                // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á error box ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô input error ‡πÄ‡∏•‡πá‡∏Å‡πÜ
            }
        }

        /** ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô UI */
        function createItemRow(item = { 
            category: '‡∏â‡∏≤‡∏Å PVC', 
            productCode: '', 
            description: '', 
            width: 0, 
            height: 0, 
            quantity: 1, 
            unitPrice: 0, 
            id: crypto.randomUUID() 
        }) {
            const row = document.createElement('div');
            row.className = 'item-row flex items-center border-b border-gray-200 text-sm py-2';
            row.dataset.id = item.id;
            
            const total = (item.quantity * item.unitPrice).toFixed(2);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á options ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
            const categoryOptions = CATEGORIES.map(cat => 
                `<option value="${cat.value}" ${item.category === cat.value ? 'selected' : ''}>${cat.label}</option>`
            ).join('');

            row.innerHTML = `
                <span class="w-8 text-center item-index font-mono text-gray-500"></span>
                <select name="category" class="w-28 border rounded mr-1 flex-shrink-0">${categoryOptions}</select>
                <input type="text" name="productCode" value="${item.productCode}" class="w-16 border rounded mr-1 flex-shrink-0" placeholder="‡∏£‡∏´‡∏±‡∏™">
                <textarea name="description" class="flex-grow p-1 ml-1 resize-none h-10 border rounded" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ">${item.description}</textarea>
                <input type="number" name="width" value="${item.width}" min="0" step="0.01" class="w-12 text-center border rounded mx-1 flex-shrink-0" placeholder="‡∏Å">
                <input type="number" name="height" value="${item.height}" min="0" step="0.01" class="w-12 text-center border rounded mx-1 flex-shrink-0" placeholder="‡∏™">
                <input type="number" name="quantity" value="${item.quantity}" min="0" class="w-12 text-center border rounded mx-1 flex-shrink-0" placeholder="‡∏à‡∏≥">
                <input type="number" name="unitPrice" value="${item.unitPrice}" min="0" step="0.01" class="w-16 text-right border rounded mx-1 flex-shrink-0" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤">
                <span class="w-20 text-right item-total font-semibold pr-1 flex-shrink-0">${parseFloat(total).toLocaleString('th-TH', { minimumFractionDigits: 2 })}</span>
                <button type="button" class="w-8 text-center text-red-500 hover:text-red-700 delete-item-btn flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                    </svg>
                </button>
            `;

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
            const inputs = row.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('input', updateTotalsUI);
            });

            // Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
            row.querySelector('.delete-item-btn').addEventListener('click', () => {
                row.remove();
                renumberItems();
                updateTotalsUI();
            });

            return row;
        }

        /** ‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà */
        function renumberItems() {
            documentElements.itemsContainer.querySelectorAll('.item-row').forEach((row, index) => {
                row.querySelector('.item-index').textContent = index + 1;
            });
        }

        /** ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏•‡∏á‡πÉ‡∏ô UI */
        function renderDocumentData(data) {
            currentDocumentData = data;
            
            documentElements.docType.value = data.documentType || '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤';
            documentElements.companyName.value = data.companyName || '‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì';
            documentElements.companyAddress.value = data.companyAddress || '';
            documentElements.customerName.value = data.customerName || '';
            documentElements.customerAddress.value = data.customerAddress || '';
            documentElements.customerContact.value = data.customerContact || '';
            documentElements.docNumber.value = data.documentNumber || '';
            documentElements.docDate.value = data.documentDate || new Date().toISOString().substring(0, 10);
            documentElements.dueDate.value = data.dueDate || '';
            documentElements.paymentDetail.value = data.paymentDetail || '';
            documentElements.documentNote.value = data.documentNote || '';
            documentElements.taxRate.value = data.taxRate || 7;
            
            // Render Items
            documentElements.itemsContainer.innerHTML = '';
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ data.items ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô Array ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const itemsToRender = (Array.isArray(data.items) && data.items.length > 0) 
                                ? data.items 
                                : [{ category: '‡∏â‡∏≤‡∏Å PVC', productCode: '', description: '', width: 0, height: 0, quantity: 1, unitPrice: 0, id: crypto.randomUUID() }];
                                
            itemsToRender.forEach(item => {
                documentElements.itemsContainer.appendChild(createItemRow(item));
            });

            renumberItems();
            updateTotalsUI();
        }

        /** ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà */
        function createNewDocument() {
            currentDocumentId = null;
            renderDocumentData({ 
                documentType: '‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤',
                documentDate: new Date().toISOString().substring(0, 10),
                companyName: '‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì'
            });
            document.querySelectorAll('#documentList button').forEach(btn => btn.closest('li').classList.remove('bg-indigo-200', 'shadow-inner'));
            document.getElementById('saveDocumentBtn').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£';
            showMessage('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        }
        
        // --- View Mode Toggle ---
        function toggleViewMode() {
            isMobileMode = !isMobileMode;

            if (isMobileMode) {
                // Switch to Mobile Mode (Full Screen)
                documentToCapture.classList.add('mobile-mode-active');
                mainContainer.classList.add('mobile-mode-active-padding');
                viewModeIcon.textContent = 'üì±';
                viewModeText.textContent = '‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠)';
                showMessage('‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠)');

            } else {
                // Switch back to Desktop Mode (A4 Mockup)
                documentToCapture.classList.remove('mobile-mode-active');
                mainContainer.classList.remove('mobile-mode-active-padding');
                viewModeIcon.textContent = 'üíª';
                viewModeText.textContent = '‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏î‡∏™‡∏Å‡πå‡∏ó‡πá‡∏≠‡∏õ (A4)';
                showMessage('‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏î‡∏™‡∏Å‡πå‡∏ó‡πá‡∏≠‡∏õ‡πÅ‡∏•‡πâ‡∏ß (A4)');
            }
        }


        // --- Firestore Setup and Data Handling ---

        /** ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Path Collection ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô */
        const getCollectionRef = () => {
            if (!db || !userId) throw new Error("Firebase or User ID not initialized.");
            // Mandatory path: /artifacts/{appId}/users/{userId}/documents
            return db.collection(`artifacts/${appId}/users/${userId}/documents`);
        };

        /** Initialise Firebase ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ */
        async function initFirebaseAndAuth() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            try {
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.firestore();
                auth = firebase.auth();
                
                // ‡πÉ‡∏ä‡πâ Custom Token ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ, ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡πÉ‡∏ä‡πâ Anonymous Auth
                await new Promise((resolve, reject) => {
                    const unsubscribe = auth.onAuthStateChanged(async (user) => {
                        unsubscribe(); // ‡∏´‡∏¢‡∏∏‡∏î‡∏ü‡∏±‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
                        if (user) {
                            userId = user.uid;
                        } else {
                            try {
                                if (initialAuthToken) {
                                    const userCredential = await auth.signInWithCustomToken(initialAuthToken);
                                    userId = userCredential.user.uid;
                                } else {
                                    const userCredential = await auth.signInAnonymously();
                                    userId = userCredential.user.uid;
                                }
                            } catch (e) {
                                console.error("Auth failed, falling back to anonymous sign-in.", e);
                                const userCredential = await auth.signInAnonymously();
                                userId = userCredential.user.uid;
                            }
                        }
                        
                        document.getElementById('currentUserId').textContent = userId;
                        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á Firestore Real-time Listener ‡∏´‡∏•‡∏±‡∏á Auth
                        fetchAndRenderDocuments();
                        resolve();
                    }, reject);
                });
                
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showMessage('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase. ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console.', true);
            } finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }
        
        /** ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ */
        async function saveDocument() {
            if (!userId) { showMessage('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á.', true); return; }
            const data = getDocumentDataFromUI();
            const saveBtn = document.getElementById('saveDocumentBtn');
            const originalText = saveBtn.textContent;
            saveBtn.disabled = true;
            saveBtn.innerHTML = `
                <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...
            `;

            try {
                if (currentDocumentId) {
                    // Update existing
                    await getCollectionRef().doc(currentDocumentId).update(data);
                    showMessage(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ #${data.documentNumber || currentDocumentId} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
                } else {
                    // Add new document
                    const docRef = await getCollectionRef().add({ 
                        ...data, 
                        createdAt: firebase.firestore.FieldValue.serverTimestamp() 
                    });
                    currentDocumentId = docRef.id;
                    showMessage(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà #${data.documentNumber || docRef.id} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
                }
            } catch (e) {
                console.error("Error saving document:", e);
                showMessage('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£: ' + e.message, true);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        /** ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏ö‡∏ö Real-time ‡πÅ‡∏•‡∏∞ Render ‡πÉ‡∏ô Sidebar */
        function fetchAndRenderDocuments() {
            if (!userId) return; // ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ userId
            
            const docList = document.getElementById('documentList');
            if (!docList) return; // Guard clause for robustness
            
            docList.innerHTML = '';
            
            // onSnapshot listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ö‡∏ö Real-time
            getCollectionRef().orderBy('updatedAt', 'desc').onSnapshot(snapshot => {
                docList.innerHTML = '';
                if (snapshot.empty) {
                    docList.innerHTML = '<li class="text-gray-500 italic">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</li>';
                    createNewDocument();
                    return;
                }

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const docId = doc.id;
                    const isActive = docId === currentDocumentId;

                    const listItem = document.createElement('li');
                    listItem.className = 'flex justify-between items-center p-2 rounded-lg transition duration-150 group ' + (isActive ? 'bg-indigo-200 shadow-inner' : 'hover:bg-gray-100');
                    listItem.innerHTML = `
                        <button class="flex-grow text-left text-sm font-medium truncate pr-2" data-doc-id="${docId}">
                            ${data.documentType || '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£'}: ${data.documentNumber || docId.substring(0, 8)} - ${data.customerName || '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}
                        </button>
                        <button class="delete-doc-btn text-red-400 hover:text-red-600 p-1 rounded-full group-hover:opacity-100 ${isActive ? 'opacity-100' : 'opacity-0'}" data-doc-id="${docId}" data-doc-name="${data.documentNumber || docId.substring(0, 8)}">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    `;
                    docList.appendChild(listItem);

                    // Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
                    listItem.querySelector('button.flex-grow').addEventListener('click', () => loadDocument(docId));
                });
                
                // Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö (‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏´‡∏•‡∏±‡∏á render)
                document.querySelectorAll('.delete-doc-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openDeleteModal(btn.dataset.docId, btn.dataset.docName);
                    });
                });

                // ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ID ‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏£‡∏Å
                if (!currentDocumentId && snapshot.docs.length > 0) {
                    loadDocument(snapshot.docs[0].id);
                } else if (currentDocumentId) {
                    // ‡∏´‡∏≤‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
                    if (!snapshot.docs.find(doc => doc.id === currentDocumentId)) {
                        createNewDocument();
                    }
                }
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                const saveBtn = document.getElementById('saveDocumentBtn');
                if (saveBtn) {
                   saveBtn.textContent = currentDocumentId ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£';
                }
                

            }, err => {
                console.error("Firestore Snapshot Error:", err);
                showMessage('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£.', true);
            });
        }
        
        /** ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏≤‡∏Å Firestore ‡πÅ‡∏•‡∏∞ Render */
        async function loadDocument(docId) {
            try {
                const docSnap = await getCollectionRef().doc(docId).get();
                if (docSnap.exists) {
                    const data = docSnap.data();
                    currentDocumentId = docId;
                    renderDocumentData(data);
                    showMessage(`‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ #${data.documentNumber || docId.substring(0, 8)} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÉ‡∏ô Sidebar
                    document.querySelectorAll('#documentList button').forEach(btn => btn.closest('li').classList.remove('bg-indigo-200', 'shadow-inner'));
                    document.querySelector(`button[data-doc-id="${docId}"]`)?.closest('li').classList.add('bg-indigo-200', 'shadow-inner');
                    const saveBtn = document.getElementById('saveDocumentBtn');
                    if (saveBtn) saveBtn.textContent = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£';
                } else {
                    showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ.', true);
                    createNewDocument();
                }
            } catch (e) {
                console.error("Error loading document:", e);
                showMessage('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£.', true);
            }
        }
        
        /** ‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ */
        async function deleteDocument(docId) {
            try {
                await getCollectionRef().doc(docId).delete();
                showMessage(`‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
                if (currentDocumentId === docId) {
                    currentDocumentId = null;
                }
            } catch (e) {
                console.error("Error deleting document:", e);
                showMessage('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£.', true);
            }
        }

        // --- Modal Handlers ---
        
        // Delete Modal
        let docIdToDelete = null;

        function openDeleteModal(docId, docName) {
            docIdToDelete = docId;
            document.getElementById('docToDeleteName').textContent = docName;
            document.getElementById('deleteModal').classList.remove('hidden');
            document.getElementById('deleteModal').classList.add('flex');
        }

        function closeDeleteModal() {
            docIdToDelete = null;
            document.getElementById('deleteModal').classList.add('hidden');
            document.getElementById('deleteModal').classList.remove('flex');
        }

        document.getElementById('cancelDeleteBtn').addEventListener('click', closeDeleteModal);
        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (docIdToDelete) {
                await deleteDocument(docIdToDelete);
            }
            closeDeleteModal();
        });

        // Preview Modal
        function openPreviewModal() {
             try {
                const previewContent = document.getElementById('previewContent');
                const inputDocument = document.getElementById('documentToCapture');
                
                // 1. ‡πÇ‡∏Ñ‡∏•‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                const data = getDocumentDataFromUI();
                const documentClone = inputDocument.cloneNode(true);
                
                // 2. ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô Preview
                documentClone.querySelector('.document-footer').style.marginTop = '4rem'; // ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á
                documentClone.querySelector('#addItemBtn').remove();
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏õ‡∏∏‡πà‡∏° AI ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                const aiBtn = documentClone.querySelector('#generatePaymentBtn');
                if (aiBtn) aiBtn.remove();
                
                // 3. ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Header ‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î Preview/PDF
                const tableHeader = documentClone.querySelector('.flex.font-bold');
                if(tableHeader) {
                    tableHeader.classList.remove('md:text-sm');
                    tableHeader.classList.add('text-xs', 'py-1');
                    // ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á '‡∏•‡∏ö' ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Header ‡πÉ‡∏ô Preview
                    const deleteHeaderSpan = tableHeader.querySelector('.w-8.text-center');
                    if (deleteHeaderSpan) deleteHeaderSpan.remove();
                }

                // 4. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà Input/Select/Textarea ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á (Text/Span) ‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á
                documentClone.querySelectorAll('.item-row').forEach((rowClone, index) => {
                    const rowData = data.items[index];
                    if (!rowData) { rowClone.remove(); return; } 

                    // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏ñ‡∏ß‡πÉ‡∏ô Preview/PDF
                    rowClone.classList.remove('py-2', 'text-sm');
                    rowClone.classList.add('py-1', 'text-xs');
                    
                    // ‡∏•‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Row ‡πÉ‡∏ô Preview
                    const deleteBtn = rowClone.querySelector('.delete-item-btn');
                    if (deleteBtn) deleteBtn.remove();
                    
                    // ######################################################################
                    // ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á/‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏á
                    // ######################################################################
                    const elementsToReplace = [
                        { name: 'category', value: rowData.category, width: 'w-28' }, // ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
                        { name: 'productCode', value: rowData.productCode, width: 'w-16' }, // ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                        { name: 'description', value: rowData.description, flex: true }, // ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                        { name: 'width', value: rowData.width ? rowData.width.toFixed(2) : '', width: 'w-12', align: 'center' }, // ‡∏Å‡∏ß‡πâ‡∏≤‡∏á
                        { name: 'height', value: rowData.height ? rowData.height.toFixed(2) : '', width: 'w-12', align: 'center' }, // ‡∏™‡∏π‡∏á
                        { name: 'quantity', value: rowData.quantity, width: 'w-12', align: 'center' }, // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
                        { name: 'unitPrice', value: rowData.unitPrice.toLocaleString('th-TH', { minimumFractionDigits: 2 }), width: 'w-16', align: 'right' } // ‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢
                    ];

                    elementsToReplace.forEach(item => {
                        const el = rowClone.querySelector(`[name="${item.name}"]`);
                        if (el) {
                            const span = document.createElement('div');
                            span.textContent = item.value;
                            // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å class ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Layout
                            const baseClass = item.flex ? 'flex-grow ml-1 mr-1' : `${item.width} mx-1 flex-shrink-0`; 
                            span.className = `p-0 ${baseClass} ${item.align ? `text-${item.align}` : ''} whitespace-nowrap overflow-hidden`;

                            el.parentNode.replaceChild(span, el);
                        }
                    });

                    // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà input/textarea ‡∏ô‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ span/div
                    rowClone.querySelectorAll('input, select, textarea').forEach(el => {
                        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö item-total ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô span ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
                        if (el.classList.contains('item-total')) return;

                        const textContent = el.tagName === 'SELECT' ? el.options[el.selectedIndex].text : el.value;
                        const displayElement = document.createElement(el.tagName === 'TEXTAREA' ? 'div' : 'span');
                        displayElement.textContent = textContent;
                        
                        // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å class ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (‡πÄ‡∏ä‡πà‡∏ô width, flex-grow) ‡πÅ‡∏•‡∏∞‡∏•‡∏ö border/padding ‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                        const className = el.className;
                        displayElement.className = className.replace('p-1', 'px-1').replace('border rounded', '').replace('resize-none', '').replace('w-full', 'w-full block');
                        
                        // ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input/select ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà (‡πÄ‡∏ä‡πà‡∏ô Company Name, Doc Type)
                        if (el.id === 'documentType' || el.id === 'companyName' || el.id === 'taxRate') {
                            displayElement.textContent = textContent;
                            displayElement.className = el.className.replace('p-2', 'px-2').replace('border-2', '').replace('bg-gray-100', '');
                        }
                        
                        el.parentNode.replaceChild(displayElement, el);
                    });
                });
                
                // ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà input/textarea ‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡∏ó‡πâ‡∏≤‡∏¢
                documentClone.querySelectorAll('.document-container input, .document-container select, .document-container textarea').forEach(el => {
                    const textContent = el.tagName === 'SELECT' ? el.options[el.selectedIndex].text : el.value;
                    const displayElement = document.createElement(el.tagName === 'TEXTAREA' ? 'div' : 'span');
                    displayElement.textContent = textContent;
                    
                    // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å class ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (‡πÄ‡∏ä‡πà‡∏ô width, flex-grow) ‡πÅ‡∏•‡∏∞‡∏•‡∏ö border/padding ‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                    const className = el.className;
                    displayElement.className = className.replace('p-1', 'px-1').replace('p-2', 'px-2').replace('border rounded', '').replace('border-2', '').replace('bg-gray-100', '');
                    
                    // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡∏≠‡∏á input date
                    if (el.type === 'date' && textContent) {
                        const date = new Date(textContent + 'T00:00:00'); // ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Timezone offset
                        displayElement.textContent = date.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
                    }
                    
                    el.parentNode.replaceChild(displayElement, el);
                });
                
                // 5. Clear existing preview and append clone
                previewContent.innerHTML = '';
                previewContent.appendChild(documentClone);
                documentClone.style.margin = '0';
                documentClone.style.boxShadow = 'none';
                documentClone.style.padding = '0'; // ‡∏•‡∏ö padding ‡πÄ‡∏î‡∏¥‡∏°
                documentClone.querySelector('div:first-child').style.padding = '3rem'; // ‡πÄ‡∏û‡∏¥‡πà‡∏° padding ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô div ‡πÅ‡∏£‡∏Å

                // 6. Show modal
                document.getElementById('previewModal').classList.remove('hidden');
                document.getElementById('previewModal').classList.add('flex');
            } catch (error) {
                console.error("Error opening preview modal:", error);
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á. ‡πÇ‡∏õ‡∏£‡∏î‡∏î‡∏π‡πÉ‡∏ô Console.', true);
            }
        }

        function closePreviewModal() {
            document.getElementById('previewModal').classList.add('hidden');
            document.getElementById('previewModal').classList.remove('flex');
        }
        
        document.getElementById('previewDocumentBtn').addEventListener('click', openPreviewModal);
        document.getElementById('closePreviewBtn').addEventListener('click', closePreviewModal);
        document.getElementById('downloadPreviewPdfBtn').addEventListener('click', () => {
             // ‡πÉ‡∏ä‡πâ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô preview modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF
             const input = document.getElementById('previewContent').querySelector('#documentToCapture');
             if (input) {
                generatePdfFromElement(input);
             } else {
                showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF', true);
             }
        });

        // --- Capture Image Logic ---
        async function captureDocumentAsImage() {
            // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Preview ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Clone ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Non-Interactive ‡∏Å‡πà‡∏≠‡∏ô
            openPreviewModal(); 
            const input = document.getElementById('previewContent').querySelector('#documentToCapture');
            
            if (!input) {
                 showMessage('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠', true);
                 closePreviewModal();
                 return;
            }

            const docName = `${documentElements.docType.value}_${documentElements.docNumber.value || 'New'}.png`;

            try {
                document.getElementById('loadingOverlay').classList.remove('hidden');
                
                // ‡πÉ‡∏ä‡πâ html2canvas ‡∏Å‡∏±‡∏ö clone ‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô modal
                const canvas = await html2canvas(input, { scale: 2, logging: false });
                const imgData = canvas.toDataURL('image/png');
                
                const link = document.createElement('a');
                link.href = imgData;
                link.download = docName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessage('‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (PNG) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');

            } catch (error) {
                console.error("Image Capture Error:", error);
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Ñ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠.', true);
            } finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
                closePreviewModal(); // ‡∏õ‡∏¥‡∏î modal ‡∏´‡∏•‡∏±‡∏á capture
            }
        }
        
        // --- PDF Generation (Unified) ---
        window.jsPDF = window.jspdf.jsPDF; 

        function generatePdfFromElement(inputElement) {
            const docName = `${documentElements.docType.value}_${documentElements.docNumber.value || 'New'}.pdf`;

             html2canvas(inputElement, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgHeight = canvas.height * pdfWidth / canvas.width;

                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                heightLeft -= pdfHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                    heightLeft -= pdfHeight;
                }
                
                pdf.save(docName);
                showMessage('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
            }).catch(error => {
                console.error("PDF Creation Error:", error);
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á PDF. ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', true);
            });
        }
        
        // --- AI Logic (Gemini API Call) ---
        const apiKey = ""; 
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function generatePaymentDetails() {
            const btn = document.getElementById('generatePaymentBtn');
            const box = document.getElementById('paymentDetail');
            if (!btn || !box) {
                 console.error('AI Button or Textarea not found.');
                 return;
            }
            
            const originalText = btn.innerHTML;
            
            btn.disabled = true; 
            btn.innerHTML = `
                <svg class="animate-spin h-4 w-4 mr-1 text-white inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...
            `;
            box.placeholder = 'AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...';
            
            const customerName = document.getElementById('customerName').value || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
            const userQuery = `‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ${customerName} (‡∏°‡∏±‡∏î‡∏à‡∏≥ 50% ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö)`;
            const systemPrompt = "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const maxRetries = 3;
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const res = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    });
                    
                    if (res.status === 429) {
                        if (attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            await sleep(delay);
                            continue; // Retry
                        } else {
                            throw new Error("Too many requests (429) and max retries reached.");
                        }
                    }

                    const data = await res.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (text) {
                        box.value = text.trim();
                        showMessage('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', false);
                    } else {
                        // Throw error if no text is returned
                         throw new Error(data.error?.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏î‡πâ');
                    }
                    break; // Success, exit loop

                } catch(e) { 
                    console.error("AI Generation Error (Attempt " + (attempt + 1) + "):", e);
                    if (attempt === maxRetries - 1) {
                         showMessage('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç AI. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏á.', true);
                    }
                } 
            }
            
            // Reset UI
            btn.disabled = false; 
            btn.innerHTML = originalText; 
            box.placeholder = '‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡∏≥‡∏£‡∏∞ 50% ‡∏°‡∏±‡∏î‡∏à‡∏≥ ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡∏ß‡∏±‡∏ô‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö';
            updateTotalsUI(); // Trigger UI update just in case
        }

        // --- Event Listeners and Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Initialize Firebase and Auth
            initFirebaseAndAuth();

            // 2. Set default date
            if (documentElements.docDate) {
                 documentElements.docDate.value = new Date().toISOString().substring(0, 10);
            }
           
            // 3. Add default item row and set up item container listeners
            const addItemBtn = document.getElementById('addItemBtn');
            if (addItemBtn) {
                addItemBtn.addEventListener('click', () => {
                    documentElements.itemsContainer.appendChild(createItemRow());
                    renumberItems();
                    updateTotalsUI();
                });
            }
            

            // 4. Global listeners for total calculation
            // Note: Listeners are added inside createItemRow for item-specific inputs.
            // This is for document level inputs (tax rate, etc.)
            Object.values(documentElements).forEach(el => {
                if (el && (el.id === 'taxRate' || el.id === 'documentType' || el.id === 'documentNumber')) {
                     el.addEventListener('input', updateTotalsUI);
                }
            });
            
            // 5. Control buttons listeners (Check for existence before adding listener)
            const newDocBtn = document.getElementById('newDocumentBtn');
            if (newDocBtn) newDocBtn.addEventListener('click', createNewDocument);
            
            const saveDocBtn = document.getElementById('saveDocumentBtn');
            if (saveDocBtn) saveDocBtn.addEventListener('click', saveDocument);
            
            const captureDocBtn = document.getElementById('captureDocumentBtn');
            if (captureDocBtn) captureDocBtn.addEventListener('click', captureDocumentAsImage);
            
            const printDocBtn = document.getElementById('printDocumentBtn');
            if (printDocBtn) printDocBtn.addEventListener('click', (e) => {
                e.preventDefault();
                openPreviewModal(); 
            });
            
            // 6. AI Button listener (for payment details generation)
            const generateAIBtn = document.getElementById('generatePaymentBtn');
            if (generateAIBtn) generateAIBtn.addEventListener('click', generatePaymentDetails);
            
            // 7. View Mode Toggle Listener (New Feature)
            if (toggleViewModeBtn) toggleViewModeBtn.addEventListener('click', toggleViewMode);
        });
    </script>
</body>
</html>
